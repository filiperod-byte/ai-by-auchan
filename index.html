<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI by Auchan - App & Admin</title>
  <link rel="manifest" href="manifest.json">

  <script src="config.js?v=1.1"></script>

  <style>
    /* --- ESTILOS GERAIS --- */
    body { margin: 0; font-family: "Roboto", Arial, sans-serif; background: linear-gradient(135deg, #d63a3e 0%, #6a1b9a 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #fff; }
    .app { width: min(420px, 95%); padding: 1rem; box-sizing: border-box; text-align: center; display: flex; flex-direction: column; min-height: 90vh; }
    .content-wrap { flex: 1; }
    .logo { width: 180px; margin: 0 auto 0.8rem auto; display: block; filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.25)); cursor: pointer; }
    .loja-info { font-size: .85rem; margin-bottom: 0.8rem; opacity: 0.9; }
    .change-store { font-size: .75rem; text-decoration: underline; cursor: pointer; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .btn { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: .5rem; display: flex; flex-direction: column; align-items: center; gap: .4rem; cursor: pointer; transition: transform .15s ease-in-out, box-shadow .15s; min-height: 160px; backdrop-filter: blur(8px); }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25); background: rgba(255, 255, 255, 0.18); }
    .btn img { width: 100%; max-width: 150px; object-fit: contain; border-radius: 14px; user-select: none; }
    .label { font-size: .9rem; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); }
    .app-footer { margin-top: 20px; font-size: 0.7rem; opacity: 0.8; font-family: sans-serif; display: flex; justify-content: center; gap: 15px; align-items: center; }
    .help-link { cursor: pointer; text-decoration: underline; font-weight: bold; color: #fff; }

    /* OVERLAYS */
    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 999; overflow-y: auto; }
    /* Position relative adicionado para o bot√£o X funcionar */
    .overlay-box { position: relative; background: #ffffff; color: #333; border-radius: 18px; padding: 1.5rem 1.2rem; width: min(380px, 90%); box-shadow: 0 10px 25px rgba(0,0,0,.35); text-align: center; margin: 2rem 0; }
    .overlay-box h2 { margin-top: 0; margin-bottom: .8rem; font-size: 1.2rem; color: #d63a3e; }
    .overlay-box select, .overlay-box input { width: 100%; padding: .6rem; border-radius: 10px; border: 1px solid #ccc; font-size: .95rem; margin-bottom: 0.8rem; box-sizing: border-box; }
    .overlay-box button { width: 100%; padding: .6rem; border-radius: 999px; border: none; font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #d63a3e, #6a1b9a); color: #fff; cursor: pointer; margin-bottom: 0.5rem; }
    .overlay-box button.secondary { background: #eee; color: #333; }
    .overlay-box button.danger { background: #ff4444; color: white; }
    .overlay-box button.cancel { background: #777; color: white; }
    .file-btn { width: auto !important; padding: 0.6rem 1rem !important; background: #666 !important; white-space: nowrap; }

    /* Bot√£o de Fechar Overlay (X) */
    .close-overlay-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        color: #999;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
    }
    .close-overlay-btn:hover { color: #d63a3e; }

    /* ADMIN TABS */
    .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; }
    .admin-tab { padding: 5px 10px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
    .admin-tab.active { border-bottom: 2px solid #d63a3e; color: #d63a3e; }
    .admin-list { text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px; font-size: 0.85rem; }
    .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .admin-item-text { flex-grow: 1; cursor: pointer; }
    .admin-item-text:hover { color: #d63a3e; font-weight: bold; }
    .admin-item button { width: auto; padding: 2px 8px; font-size: 0.7rem; margin: 0; background: #ff4444; margin-left: 10px;}
    
    .version-control { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: left; border: 1px solid #eee; }
    .version-control label { font-size: 0.8rem; color: #666; display: block; margin-bottom: 3px; }
    
    /* Tutorial */
    .tutorial-step { text-align: left; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .tutorial-icon { font-size: 1.5rem; line-height: 1; }
    .ios-share-icon { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
  </style>
</head>
<body>

  <div id="login-overlay" class="overlay">
    <div class="overlay-box" style="width: min(300px, 80%);">
        <span class="close-overlay-btn" onclick="fecharLogin()">‚úï</span>
        
        <h2>√Årea Reservada</h2>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Insere a senha de administrador</p>
        <input type="password" id="login-password-input" placeholder="Senha" onkeyup="if(event.key === 'Enter') verificarSenhaLogin()">
        <button onclick="verificarSenhaLogin()">Entrar</button>
        <button class="secondary" onclick="fecharLogin()">Cancelar</button>
    </div>
  </div>

  <div id="loja-overlay" class="overlay">
    <div class="overlay-box">
      <span class="close-overlay-btn" onclick="fecharLojaOverlay()">‚úï</span>
      <h2>Escolhe formato e loja</h2>
      <select id="formato-select" onchange="atualizarSelectLojas()">
        <option value="" disabled selected>Seleciona o formato‚Ä¶</option>
      </select>
      <select id="loja-select" onchange="this.blur()">
        <option value="" disabled selected>Seleciona a loja‚Ä¶</option>
      </select>
      <button onclick="guardarLoja()">Guardar</button>
      <small>Podes mudar depois em ‚ÄúLoja: ‚Ä¶ (alterar)‚Äù</small>
    </div>
  </div>

  <div id="help-overlay" class="overlay">
    <div class="overlay-box">
        <span class="close-overlay-btn" onclick="document.getElementById('help-overlay').style.display='none'">‚úï</span>
        <h2>üì≤ Instalar App</h2>
        
        <div id="help-ios">
            <p style="margin-bottom:15px; font-weight:bold; color:#666;">iPhone / iPad (iOS)</p>
            <div class="tutorial-step">
                <span class="tutorial-icon">1Ô∏è‚É£</span>
                <span>Toca no bot√£o de <b>Partilha</b> (quadrado com seta) na barra inferior do Safari.<br>
                <svg class="ios-share-icon" viewBox="0 0 50 50" style="width:24px; margin-top:5px;"><path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/><path d="M24 7h2v21h-2z"/><path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-0.6 0-1 0.4-1 1v18c0 0.6 0.4 1 1 1h20c0.6 0 1-0.4 1-1V19c0-0.6-0.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/></svg>
                </span>
            </div>
            <div class="tutorial-step">
                <span class="tutorial-icon">2Ô∏è‚É£</span>
                <span>Rola para baixo e escolhe a op√ß√£o <b>"Adicionar ao Ecr√£ Principal"</b> (Add to Home Screen).</span>
            </div>
            <div class="tutorial-step">
                <span class="tutorial-icon">3Ô∏è‚É£</span>
                <span>Clica em <b>Adicionar</b> no topo direito.</span>
            </div>
        </div>

        <hr style="margin: 15px 0; opacity: 0.3;">

        <div id="help-android">
            <p style="margin-bottom:15px; font-weight:bold; color:#666;">Android (Chrome)</p>
            <div class="tutorial-step">
                <span>Toca nos 3 pontinhos (‚ãÆ) e escolhe <b>"Instalar Aplica√ß√£o"</b> ou "Adicionar ao Ecr√£ Principal".</span>
            </div>
        </div>

        <button class="secondary" onclick="document.getElementById('help-overlay').style.display='none'">Entendi</button>
    </div>
  </div>

  <div id="admin-overlay" class="overlay">
    <div class="overlay-box" style="width: min(450px, 95%);">
      <h2>Painel de Administra√ß√£o</h2>
      <div class="admin-tabs">
        <div class="admin-tab active" onclick="switchAdminTab('lojas')">Lojas</div>
        <div class="admin-tab" onclick="switchAdminTab('assistentes')">Assistentes</div>
        <div class="admin-tab" onclick="switchAdminTab('exportar')">Guardar</div>
      </div>

      <div id="admin-tab-lojas">
        <div class="admin-list" id="admin-lojas-list"></div>
        <h3>Adicionar Loja</h3>
        <select id="admin-novo-formato">
          <option value="Hiper">Hiper</option>
          <option value="Super">Super</option>
          <option value="Prox">Prox</option>
          <option value="Servicos">Servi√ßos</option>
        </select>
        <div style="display:flex; gap:5px;">
            <input type="text" id="admin-nova-loja-cod" placeholder="Cod" maxlength="3" style="width: 80px;">
            <input type="text" id="admin-nova-loja-nome" placeholder="Nome da Loja" style="flex:1;">
        </div>
        <button onclick="adminAddLoja()">Adicionar Loja</button>
      </div>

      <div id="admin-tab-assistentes" style="display:none;">
        <div class="admin-list" id="admin-assistentes-list"></div>
        <h3 id="admin-ast-title">Adicionar Assistente</h3>
        <small style="display:block; margin-bottom:10px; color:#666;">Clica na lista acima para editar</small>
        
        <input type="text" id="admin-ast-label" placeholder="Nome no Bot√£o (Label)">
        <input type="text" id="admin-ast-url" placeholder="URL Destino">
        
        <div style="display:flex; gap:5px; align-items:center;">
            <input type="text" id="admin-ast-icone" placeholder="Nome Imagem (ex: wally.jpg)" style="margin-bottom:0.8rem; flex:1;">
            <input type="file" id="admin-file-picker" style="display:none" onchange="selecionarImagemArquivo()">
            <button class="file-btn" onclick="document.getElementById('admin-file-picker').click()" style="margin-bottom:0.8rem;" title="Escolher ficheiro">üìÇ</button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom: 0.8rem;">
           <select id="admin-ast-formato" style="margin-bottom:0;" onchange="atualizarSelectLojasAdmin()">
                <option value="*">Qualquer Formato (*)</option>
           </select>
           <select id="admin-ast-loja" style="margin-bottom:0;">
                <option value="*">Qualquer Loja (*)</option>
           </select>
        </div>
        <div style="display: flex; gap: 5px;">
            <button onclick="adminSaveAssistente()" id="btn-save-ast">Adicionar Assistente</button>
            <button onclick="cancelarEdicao()" id="btn-cancel-ast" class="cancel" style="display:none;">Cancelar</button>
        </div>
      </div>

      <div id="admin-tab-exportar" style="display:none;">
        <p style="font-size: 0.85rem; margin-bottom: 10px;">
            Gera e baixa o ficheiro <b>config.js</b>. Depois, faz upload apenas deste ficheiro para o GitHub.
        </p>
        
        <div class="version-control">
            <label>Vers√£o Atual:</label>
            <strong id="lbl-versao-atual" style="color:#333;">...</strong>
            <br><br>
            <label>Nova Vers√£o (sugest√£o):</label>
            <input type="text" id="input-nova-versao" style="width: 100%; margin-bottom:0;" placeholder="Ex: v1.1.1">
        </div>

        <button onclick="baixarConfiguracao()">üì• Download Ficheiro de Configura√ß√£o</button>
        <button class="danger" onclick="limparTudoAdmin()">‚ö†Ô∏è Reset de F√°brica</button>
      </div>

      <hr>
      <button class="secondary" onclick="fecharAdmin()">Fechar Admin</button>
    </div>
  </div>

  <div class="app">
    <div class="content-wrap">
        <img src="AibyAuchan.png" alt="AI by Auchan" class="logo" id="logo-trigger">
        <div class="loja-info">
          Loja: <span id="loja-nome">a definir‚Ä¶</span>
          <span class="change-store" onclick="forcarEscolhaLoja()">(alterar)</span>
        </div>
        <div class="grid"></div>
    </div>
    <div class="app-footer">
        <span class="help-link" onclick="document.getElementById('help-overlay').style.display='flex'">üì≤ Instalar App</span>
        <span id="app-footer-version" style="opacity:0.7">...</span>
    </div>
  </div>

  <script>
    /* --- L√ìGICA PRINCIPAL --- */
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeGFYjlrXC27y-a8sXgdnxKD4XzT8yImmL_0CZRXP26NwjQhQ/formResponse';
    const ENTRY_LOJA = 'entry.1749648688';
    const ENTRY_ASSISTENTE = 'entry.182917282';
    const FORMATO_KEY = 'formatoSelecionado';
    const LOJA_KEY = 'lojaSelecionada';
    const ADMIN_PASSWORD = "9602"; 

    let STATE = { lojas: [], assistentes: [] };
    let editingAssistenteIndex = -1; 
    let DADOS_PADRAO_FALLBACK = { lojas: [], assistentes: [] };

    window.addEventListener('load', () => {
      carregarDados();
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(console.log);
    });

    function carregarDados() {
      if (typeof DADOS_PADRAO === 'undefined') {
          console.warn("Ficheiro config.js n√£o encontrado.");
          DADOS_PADRAO = DADOS_PADRAO_FALLBACK;
          STORAGE_DATA_KEY = "v0.0";
      }
      const dadosLocais = localStorage.getItem(STORAGE_DATA_KEY);
      if (dadosLocais) { STATE = JSON.parse(dadosLocais); } 
      else { STATE = JSON.parse(JSON.stringify(DADOS_PADRAO)); }
      renderizarApp();
      atualizarVersaoRodape();
    }

    function atualizarVersaoRodape() {
        let versao = "Desconhecida";
        if (typeof STORAGE_DATA_KEY !== 'undefined') { versao = STORAGE_DATA_KEY.split('_')[1] || 'vX.X'; }
        document.getElementById('app-footer-version').textContent = `Powered By G2G IAD3.0 ${versao.toUpperCase()}`;
    }

    function guardarDadosLocais() { localStorage.setItem(STORAGE_DATA_KEY, JSON.stringify(STATE)); renderizarApp(); }
    function renderizarApp() { atualizarSelectFormato(); atualizarUILoja(); }
    function formatarTextoBonito(t) { if (!t || t === "*") return t; return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase(); }
    function ordenarLojas(a, b) { return a.loja.localeCompare(b.loja, undefined, { numeric: true, sensitivity: 'base' }); }
    function obterFormatosUnicos() { 
        const raw = STATE.lojas.map(l => l.formato ? formatarTextoBonito(l.formato) : "");
        return [...new Set(raw)].filter(f => f !== "").sort();
    }

    function atualizarSelectFormato() {
      const s = document.getElementById('formato-select'); const val = s.value;
      s.innerHTML = '<option value="" disabled selected>Seleciona o formato‚Ä¶</option>';
      obterFormatosUnicos().forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; s.appendChild(o); });
      if (val) s.value = val;
    }

    function atualizarSelectLojas() {
      const fmt = document.getElementById('formato-select').value;
      const s = document.getElementById('loja-select');
      s.innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      if (!fmt) return;
      const fmtN = fmt.toUpperCase();
      const ljs = STATE.lojas.filter(l => (l.formato || '').toUpperCase() === fmtN);
      ljs.sort(ordenarLojas);
      ljs.forEach(l => { const o = document.createElement('option'); o.value = l.loja; o.textContent = l.loja; s.appendChild(o); });
    }

    function atualizarUILoja() {
      const f = localStorage.getItem(FORMATO_KEY); const l = localStorage.getItem(LOJA_KEY);
      const span = document.getElementById('loja-nome'); const over = document.getElementById('loja-overlay');
      if (f && l) { span.textContent = `${formatarTextoBonito(f)} ‚Äì ${l}`; over.style.display = 'none'; renderizarGridAssistentes(f, l); } 
      else { span.textContent = 'a definir‚Ä¶'; over.style.display = 'flex'; document.querySelector('.grid').innerHTML = ''; }
    }

    function fecharLojaOverlay() {
        document.getElementById('loja-overlay').style.display = 'none';
    }

    function renderizarGridAssistentes(uf, ul) {
      const grid = document.querySelector('.grid'); grid.innerHTML = '';
      const ufN = uf.toUpperCase(); const ulN = ul.toUpperCase();
      const matches = STATE.assistentes.filter(a => {
        const f = (a.formato || '').toUpperCase(); const l = (a.loja || '').toUpperCase();
        return (f === '*' || f === ufN) && (l === '*' || l === ulN);
      });
      matches.sort((a, b) => a.label.localeCompare(b.label));
      if(matches.length === 0) { grid.innerHTML = '<p style="grid-column: span 2; opacity: 0.7;">Nenhum assistente dispon√≠vel.</p>'; return; }
      matches.forEach(a => {
        const btn = document.createElement('div'); btn.className = 'btn';
        
        // CORRE√á√ÉO AQUI: Abrir em nova aba (_blank)
        btn.onclick = () => abrirAssistente(a.nome, a.url);
        
        const img = document.createElement('img'); img.src = a.icone || 'AibyAuchan.png'; img.onerror = function() { this.src = 'AibyAuchan.png'; };
        const lbl = document.createElement('div'); lbl.className = 'label'; lbl.textContent = a.label || a.nome;
        btn.appendChild(img); btn.appendChild(lbl); grid.appendChild(btn);
      });
    }

    function guardarLoja() {
      const f = document.getElementById('formato-select').value; const l = document.getElementById('loja-select').value;
      if (!f || !l) return alert('Escolhe formato e loja.');
      localStorage.setItem(FORMATO_KEY, f); localStorage.setItem(LOJA_KEY, l); atualizarUILoja();
    }
    function forcarEscolhaLoja() {
      document.getElementById('formato-select').value = ""; document.getElementById('loja-select').innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      document.getElementById('loja-overlay').style.display = 'flex';
    }
    
    function abrirAssistente(n, u) {
      const l = localStorage.getItem(LOJA_KEY) || 'Sem loja';
      const p = new URLSearchParams(); p.append(ENTRY_LOJA, l); p.append(ENTRY_ASSISTENTE, n);
      
      // Envia os dados para o Google Forms em segundo plano
      fetch(FORM_BASE_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: p.toString() }).catch(e=>{});
      
      // Abre o assistente NUMA NOVA ABA
      window.open(u, '_blank');
    }

    /* --- ADMIN --- */
    let lc = 0;
    document.getElementById('logo-trigger').addEventListener('click', () => { lc++; if (lc === 5) { lc=0; abrirLogin(); } });
    function abrirLogin() { document.getElementById('login-overlay').style.display = 'flex'; setTimeout(()=>document.getElementById('login-password-input').focus(),100); }
    function fecharLogin() { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('login-password-input').value=''; }
    function verificarSenhaLogin() { if(document.getElementById('login-password-input').value === ADMIN_PASSWORD) { fecharLogin(); abrirAdmin(); } else { alert("Senha incorreta."); } }
    function abrirAdmin() { document.getElementById('admin-overlay').style.display = 'flex'; renderizarAdminListas(); atualizarDropdownsAdminInicial(); }
    function fecharAdmin() { document.getElementById('admin-overlay').style.display = 'none'; cancelarEdicao(); }
    function switchAdminTab(t) {
      document.querySelectorAll('.admin-tab').forEach(x => x.classList.remove('active'));
      ['lojas','assistentes','exportar'].forEach(id => document.getElementById(`admin-tab-${id}`).style.display='none');
      document.getElementById(`admin-tab-${t}`).style.display='block';
      if(t==='lojas') document.querySelectorAll('.admin-tab')[0].classList.add('active');
      if(t==='assistentes') { document.querySelectorAll('.admin-tab')[1].classList.add('active'); atualizarDropdownsAdminInicial(); }
      if(t==='exportar') { document.querySelectorAll('.admin-tab')[2].classList.add('active'); atualizarSugestaoVersao(); }
    }

    function renderizarAdminListas() {
      const ll = document.getElementById('admin-lojas-list'); ll.innerHTML = '';
      const lSorted = [...STATE.lojas].sort(ordenarLojas);
      lSorted.forEach(l => {
        const idx = STATE.lojas.indexOf(l);
        const d = document.createElement('div'); d.className='admin-item';
        d.innerHTML = `<span>${formatarTextoBonito(l.formato)} - ${l.loja}</span><button onclick="adminRemoverLoja(${idx})">X</button>`;
        ll.appendChild(d);
      });
      const al = document.getElementById('admin-assistentes-list'); al.innerHTML = '';
      const aSorted = [...STATE.assistentes].sort((a,b)=>a.label.localeCompare(b.label));
      aSorted.forEach(a => {
        const idx = STATE.assistentes.indexOf(a);
        const d = document.createElement('div'); d.className='admin-item';
        d.innerHTML = `<div class="admin-item-text" onclick="prepararEdicao(${idx})">${a.label} <small style="opacity:0.7">(${a.formato})(${a.loja})</small></div><button onclick="adminRemoverAssistente(event, ${idx})">X</button>`;
        al.appendChild(d);
      });
    }

    function atualizarDropdownsAdminInicial() {
       const s = document.getElementById('admin-ast-formato'); const prev = s.value;
       s.innerHTML = '<option value="*">Qualquer Formato (*)</option>';
       obterFormatosUnicos().forEach(f => { const o = document.createElement('option'); o.value=f; o.textContent=f; s.appendChild(o); });
       if(prev) s.value = prev;
       atualizarSelectLojasAdmin();
    }
    function atualizarSelectLojasAdmin() {
       const sf = document.getElementById('admin-ast-formato'); const sl = document.getElementById('admin-ast-loja');
       const prev = sl.value; sl.innerHTML = '<option value="*">Qualquer Loja (*)</option>';
       let list = [];
       if(sf.value === '*') list = [...STATE.lojas];
       else list = STATE.lojas.filter(l => (l.formato||'').toUpperCase() === sf.value.toUpperCase());
       list.sort(ordenarLojas);
       list.forEach(l => { const o = document.createElement('option'); o.value=l.loja; o.textContent=l.loja; sl.appendChild(o); });
       sl.value = (Array.from(sl.options).some(o=>o.value===prev)) ? prev : '*';
    }

    function selecionarImagemArquivo() {
        const i = document.getElementById('admin-file-picker');
        if (i.files && i.files[0]) document.getElementById('admin-ast-icone').value = i.files[0].name;
    }

    function adminAddLoja() {
        let f = document.getElementById('admin-novo-formato').value;
        const c = document.getElementById('admin-nova-loja-cod').value.trim();
        const n = document.getElementById('admin-nova-loja-nome').value.trim();
        if(!c || !n) return alert("Preenche c√≥digo e nome.");
        f = formatarTextoBonito(f); const lc = `${c}-${n}`;
        if(STATE.lojas.some(l=>l.formato===f && l.loja===lc)) return alert("Loja j√° existe.");
        STATE.lojas.push({formato:f, loja:lc});
        guardarDadosLocais(); renderizarAdminListas(); atualizarDropdownsAdminInicial();
        document.getElementById('admin-nova-loja-cod').value=''; document.getElementById('admin-nova-loja-nome').value='';
    }
    function adminRemoverLoja(i) { if(confirm("Apagar?")) { STATE.lojas.splice(i,1); guardarDadosLocais(); renderizarAdminListas(); atualizarDropdownsAdminInicial(); } }

    function prepararEdicao(i) {
        editingAssistenteIndex = i; const a = STATE.assistentes[i];
        document.getElementById('admin-ast-label').value = a.label;
        document.getElementById('admin-ast-url').value = a.url;
        document.getElementById('admin-ast-icone').value = a.icone;
        document.getElementById('admin-ast-formato').value = formatarTextoBonito(a.formato);
        atualizarSelectLojasAdmin();
        document.getElementById('admin-ast-loja').value = a.loja;
        document.getElementById('admin-ast-title').innerText = "Editar Assistente";
        document.getElementById('btn-save-ast').innerText = "Atualizar";
        document.getElementById('btn-cancel-ast').style.display = "block";
    }
    function cancelarEdicao() {
        editingAssistenteIndex = -1;
        ['admin-ast-label','admin-ast-url','admin-ast-icone'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('admin-ast-formato').value='*'; atualizarSelectLojasAdmin();
        document.getElementById('admin-ast-title').innerText="Adicionar Assistente";
        document.getElementById('btn-save-ast').innerText="Adicionar";
        document.getElementById('btn-cancel-ast').style.display="none";
    }
    function adminSaveAssistente() {
        const l = document.getElementById('admin-ast-label').value.trim();
        const n = l;
        const u = document.getElementById('admin-ast-url').value.trim();
        const i = document.getElementById('admin-ast-icone').value.trim();
        let f = document.getElementById('admin-ast-formato').value || '*';
        const loj = document.getElementById('admin-ast-loja').value || '*';
        if(f !== '*') f = formatarTextoBonito(f);
        if(!l || !u) return alert("Falta Nome ou URL");
        
        const novo = {formato:f, loja:loj, nome:n, label:l, url:u, icone:i};
        const dup = STATE.assistentes.some((a, idx) => {
            if(editingAssistenteIndex === idx) return false;
            return a.nome===novo.nome && a.label===novo.label && a.url===novo.url && a.formato===novo.formato && a.loja===novo.loja;
        });
        if(dup) return alert("Assistente duplicado!");

        if(editingAssistenteIndex >= 0) STATE.assistentes[editingAssistenteIndex] = novo;
        else STATE.assistentes.push(novo);
        guardarDadosLocais(); renderizarAdminListas(); cancelarEdicao();
    }
    function adminRemoverAssistente(e, i) { e.stopPropagation(); if(confirm("Apagar?")) { STATE.assistentes.splice(i,1); guardarDadosLocais(); renderizarAdminListas(); if(editingAssistenteIndex===i) cancelarEdicao(); } }

    /* --- EXPORTAR CONFIG.JS --- */
    function atualizarSugestaoVersao() {
        let v = "1.0";
        if(typeof STORAGE_DATA_KEY !== 'undefined') v = STORAGE_DATA_KEY.split('_v')[1] || "1.0";
        document.getElementById('lbl-versao-atual').textContent = "v" + v;
        let p = v.split('.').map(Number); if(p.length===2) p.push(0);
        p[p.length-1]++;
        document.getElementById('input-nova-versao').value = "v" + p.join('.');
    }

    function baixarConfiguracao() {
      let vUser = document.getElementById('input-nova-versao').value.trim();
      if(vUser.startsWith('v')) vUser = vUser.substring(1);
      const newKey = "appConfigData_v" + vUser;

      STATE.lojas.forEach(l => { if(l.formato) l.formato = formatarTextoBonito(l.formato); });
      STATE.assistentes.forEach(a => { if(a.formato && a.formato!=='*') a.formato = formatarTextoBonito(a.formato); });
      STATE.lojas.sort(ordenarLojas);
      STATE.assistentes.sort((a,b)=>a.label.localeCompare(b.label));

      let content = `// Ficheiro de Configura√ß√£o Gerado Automaticamente\n`;
      content += `const STORAGE_DATA_KEY = "${newKey}";\n\n`;
      content += `const DADOS_PADRAO = {\n`;
      content += `  lojas: [\n`;
      STATE.lojas.forEach((l, i) => {
          let line = JSON.stringify(l);
          if(i < STATE.lojas.length - 1) line += ",";
          content += `    ${line}\n`;
      });
      content += `  ],\n`;
      content += `  assistentes: [\n`;
      STATE.assistentes.forEach((a, i) => {
          let block = JSON.stringify(a, null, 4);
          block = block.split('\n').map(line => "    " + line).join('\n');
          if(i < STATE.assistentes.length - 1) block += ",";
          content += `${block}\n`;
      });
      content += `  ]\n`;
      content += `};\n`;

      const blob = new Blob([content], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "config.js";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert("Ficheiro config.js baixado!\nFaz upload dele para a pasta do GitHub.");
    }

    function limparTudoAdmin() {
      if(confirm("Resetar F√°brica?")) { localStorage.removeItem(STORAGE_DATA_KEY); location.reload(); }
    }
  </script>
</body>
</html>