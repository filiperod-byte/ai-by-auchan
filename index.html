<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI by Auchan - App & Admin</title>
  <link rel="manifest" href="manifest.json">

  <script>
    // Cache-bust do config.js
    (function () {
      var versaoUnica = new Date().getTime();
      document.write('<script src="config.js?v=' + versaoUnica + '"><\/script>');
    })();
  </script>

  <style>
    /* --- ESTILOS GERAIS --- */
    body { margin: 0; font-family: "Roboto", Arial, sans-serif; background: linear-gradient(135deg, #d63a3e 0%, #6a1b9a 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #fff; }
    .app { width: min(420px, 95%); padding: 1rem; box-sizing: border-box; text-align: center; display: flex; flex-direction: column; min-height: 90vh; }
    .content-wrap { flex: 1; }
    .logo { width: 180px; margin: 0 auto 0.8rem auto; display: block; filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.25)); cursor: pointer; }
    .loja-info { font-size: .85rem; margin-bottom: 0.8rem; opacity: 0.9; }
    .change-store { font-size: .75rem; text-decoration: underline; cursor: pointer; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .btn { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: .5rem; display: flex; flex-direction: column; align-items: center; gap: .4rem; cursor: pointer; transition: transform .15s ease-in-out, box-shadow .15s; min-height: 160px; backdrop-filter: blur(8px); }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25); background: rgba(255, 255, 255, 0.18); }
    .btn img { width: 100%; max-width: 150px; object-fit: contain; border-radius: 14px; user-select: none; }
    .label { font-size: .9rem; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); }
    .app-footer { margin-top: 20px; font-size: 0.7rem; opacity: 0.8; font-family: sans-serif; display: flex; justify-content: center; gap: 15px; align-items: center; }
    .help-link { cursor: pointer; text-decoration: underline; font-weight: bold; color: #fff; }

    /* OVERLAYS */
    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 999; overflow-y: auto; padding: 24px 0; }
    .overlay-box { position: relative; background: #ffffff; color: #333; border-radius: 18px; padding: 1.5rem 1.2rem; width: min(380px, 90%); box-shadow: 0 10px 25px rgba(0,0,0,.35); text-align: center; margin: 0; }
    .overlay-box h2 { margin-top: 0; margin-bottom: .8rem; font-size: 1.2rem; color: #d63a3e; }
    .overlay-box select, .overlay-box input, .overlay-box textarea { width: 100%; padding: .6rem; border-radius: 10px; border: 1px solid #ccc; font-size: .95rem; margin-bottom: 0.8rem; box-sizing: border-box; }
    .overlay-box textarea { resize: vertical; min-height: 80px; }
    .overlay-box button { width: 100%; padding: .6rem; border-radius: 999px; border: none; font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #d63a3e, #6a1b9a); color: #fff; cursor: pointer; margin-bottom: 0.5rem; }
    .overlay-box button.secondary { background: #eee; color: #333; }
    .overlay-box button.danger { background: #ff4444; color: white; }
    .overlay-box button.cancel { background: #777; color: white; }
    .file-btn { width: auto !important; padding: 0.6rem 1rem !important; background: #666 !important; white-space: nowrap; }

    /* Bot√£o de Fechar Overlay (X) */
    .close-overlay-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
    .close-overlay-btn:hover { color: #d63a3e; }

    /* MODAL: altera√ß√µes por publicar */
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .modal-actions button { margin-bottom: 0; }
    .modal-actions .ghost { background: #f2f2f2; color: #333; }
    .modal-actions .warn { background: #ff9800; color: #fff; }
    @media (max-width: 420px) {
      .modal-actions { flex-direction: column; }
    }

    /* ADMIN TABS */
    .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap; }
    .admin-tab { padding: 5px 10px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
    .admin-tab.active { border-bottom: 2px solid #d63a3e; color: #d63a3e; }
    .admin-list { text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px; font-size: 0.85rem; }
    .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .admin-item-text { flex-grow: 1; cursor: pointer; }
    .admin-item-text:hover { color: #d63a3e; font-weight: bold; }
    .admin-item button { width: auto; padding: 2px 8px; font-size: 0.7rem; margin: 0; border: 0; border-radius: 999px; cursor: pointer; }
    .admin-item button.delete { background: #ff4444; color: #fff; }
    .admin-item button.dup { background: #666; color: #fff; }

    .version-control { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: left; border: 1px solid #eee; }
    .version-control label { font-size: 0.8rem; color: #666; display: block; margin-bottom: 3px; }

    /* Tutorial */
    .tutorial-step { text-align: left; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .tutorial-icon { font-size: 1.5rem; line-height: 1; }
    .ios-share-icon { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }

    /* HELP TABS */
    .help-tabs { display:flex; justify-content:center; gap:10px; margin: 0 0 12px 0; flex-wrap:wrap; }
    .help-tab { padding: 6px 10px; cursor:pointer; border-bottom:2px solid transparent; font-weight:800; color:#666; }
    .help-tab.active { border-bottom:2px solid #d63a3e; color:#d63a3e; }
    .help-panel { display:none; }
    .help-panel.active { display:block; }

    /* QRCodes list badges + alinhamento checkbox √† direita */
    .qr-row { display:flex; align-items:center; gap:12px; padding:10px 12px; border-bottom:1px solid #eee; cursor:pointer; user-select:none; background:#fff; }
    .qr-row.badge-alterado { background: #fff3e0; }
    .qr-row.badge-novo { background: #e3f2fd; }
    .qr-badge { font-size: .85rem; font-weight: 900; white-space: nowrap; }
    .qr-badge.alterado { color: #ef6c00; }
    .qr-badge.novo { color: #1565c0; }

    /* ADMIN LAYOUT FIX: tabs sempre vis√≠veis mesmo com muitos itens */
    .admin-box { width: min(520px, 95%); padding: 0; text-align: left; display:flex; flex-direction:column; max-height: calc(100vh - 48px); overflow: hidden; }
    .admin-head { padding: 1.1rem 1.2rem 0.2rem 1.2rem; background:#fff; position: sticky; top: 0; z-index: 5; border-top-left-radius: 18px; border-top-right-radius: 18px; }
    .admin-head h2 { text-align:center; margin:0 0 .8rem 0; }
    .admin-tabs-wrap { padding: 0 1.2rem 0.8rem 1.2rem; background:#fff; position: sticky; top: 52px; z-index: 5; border-bottom: 1px solid #f0f0f0; }
    .admin-body { padding: 1rem 1.2rem; overflow: auto; flex: 1; }
    .admin-foot { padding: 0.9rem 1.2rem 1.2rem 1.2rem; background:#fff; position: sticky; bottom: 0; z-index: 5; border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; border-top: 1px solid #f0f0f0; }
    .admin-foot hr { margin: 10px 0; opacity: .2; }
    .admin-foot button { margin-bottom: 0; }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login-overlay" class="overlay">
    <div class="overlay-box" style="width: min(300px, 80%);">
      <span class="close-overlay-btn" onclick="fecharLogin()">‚úï</span>
      <h2>√Årea Reservada</h2>
      <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Insere a senha de administrador</p>
      <input type="password" id="login-password-input" placeholder="Senha" onkeyup="if(event.key === 'Enter') verificarSenhaLogin()">
      <button onclick="verificarSenhaLogin()">Entrar</button>
      <button class="secondary" onclick="fecharLogin()">Cancelar</button>
    </div>
  </div>

  <!-- LOJA -->
  <div id="loja-overlay" class="overlay">
    <div class="overlay-box">
      <span class="close-overlay-btn" onclick="fecharLojaOverlay()">‚úï</span>
      <h2>Escolhe formato e loja</h2>
      <select id="formato-select" onchange="atualizarSelectLojas()">
        <option value="" disabled selected>Seleciona o formato‚Ä¶</option>
      </select>
      <select id="loja-select" onchange="this.blur()">
        <option value="" disabled selected>Seleciona a loja‚Ä¶</option>
      </select>
      <button onclick="guardarLoja()">Guardar</button>
      <small>Podes mudar depois em ‚ÄúLoja: ‚Ä¶ (alterar)‚Äù</small>
    </div>
  </div>

  <!-- HELP -->
  <div id="help-overlay" class="overlay">
    <div class="overlay-box" style="width:min(520px,95%); text-align:center;">
      <span class="close-overlay-btn" onclick="document.getElementById('help-overlay').style.display='none'">‚úï</span>
      <h2>üì≤ Instalar App</h2>

      <div class="help-tabs">
        <div class="help-tab active" data-htab="ios" onclick="switchHelpTab_('ios')">iOS</div>
        <div class="help-tab" data-htab="android" onclick="switchHelpTab_('android')">Android</div>
        <div class="help-tab" data-htab="windows" onclick="switchHelpTab_('windows')">Windows</div>
      </div>

      <div id="help-panel-ios" class="help-panel active">
        <p style="margin: 0 0 12px 0; font-weight:800; color:#666;">iPhone / iPad (Safari)</p>

        <div class="tutorial-step">
          <span class="tutorial-icon">1Ô∏è‚É£</span>
          <span>
            Toca no bot√£o de <b>Partilha</b> (quadrado com seta) na barra inferior do Safari.<br>
            <svg class="ios-share-icon" viewBox="0 0 50 50" style="width:24px; margin-top:5px;">
              <path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/>
              <path d="M24 7h2v21h-2z"/>
              <path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-0.6 0-1 0.4-1 1v18c0 0.6 0.4 1 1 1h20c0.6 0 1-0.4 1-1V19c0-0.6-0.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/>
            </svg>
          </span>
        </div>

        <div class="tutorial-step">
          <span class="tutorial-icon">2Ô∏è‚É£</span>
          <span>Rola para baixo e escolhe <b>"Adicionar ao Ecr√£ Principal"</b>.</span>
        </div>

        <div class="tutorial-step" style="border-bottom:none; padding-bottom:0;">
          <span class="tutorial-icon">3Ô∏è‚É£</span>
          <span>Clica em <b>Adicionar</b> no topo direito.</span>
        </div>
      </div>

      <div id="help-panel-android" class="help-panel">
        <p style="margin: 0 0 12px 0; font-weight:800; color:#666;">Android (Chrome)</p>
        <div class="tutorial-step" style="border-bottom:none; padding-bottom:0;">
          <span class="tutorial-icon">‚úÖ</span>
          <span>
            Abre no Chrome, toca nos <b>3 pontinhos (‚ãÆ)</b> e escolhe <b>"Instalar Aplica√ß√£o"</b> ou <b>"Adicionar ao ecr√£ principal"</b>.
          </span>
        </div>
      </div>

      <div id="help-panel-windows" class="help-panel">
        <p style="margin: 0 0 12px 0; font-weight:800; color:#666;">Windows (Chrome / Edge)</p>
        <div class="tutorial-step">
          <span class="tutorial-icon">1Ô∏è‚É£</span>
          <span>Abre a App no Chrome/Edge.</span>
        </div>
        <div class="tutorial-step">
          <span class="tutorial-icon">2Ô∏è‚É£</span>
          <span>Procura o √≠cone <b>Instalar</b> (normalmente no fim da barra de endere√ßos) ou abre o menu ‚ãÆ.</span>
        </div>
        <div class="tutorial-step" style="border-bottom:none; padding-bottom:0;">
          <span class="tutorial-icon">3Ô∏è‚É£</span>
          <span>Escolhe <b>"Instalar AI by Auchan"</b>. Vai abrir como app (sem ‚Äútabs‚Äù a gritar contigo üòÖ).</span>
        </div>
      </div>

      <button class="secondary" onclick="document.getElementById('help-overlay').style.display='none'" style="margin-top:14px;">Entendi</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin-overlay" class="overlay">
    <div class="overlay-box admin-box">
      <div class="admin-head">
        <h2>Painel de Administra√ß√£o</h2>
      </div>

      <!-- Ordem: Lojas, Assistentes, QRCodes, Guardar -->
      <div class="admin-tabs-wrap">
        <div class="admin-tabs" style="margin-bottom:0;">
          <div class="admin-tab active" data-tab="lojas" onclick="switchAdminTab('lojas')">Lojas</div>
          <div class="admin-tab" data-tab="assistentes" onclick="switchAdminTab('assistentes')">Assistentes</div>
          <div class="admin-tab" data-tab="qrcodes" onclick="switchAdminTab('qrcodes')">QRCodes</div>
          <div class="admin-tab" data-tab="exportar" onclick="switchAdminTab('exportar')">Guardar</div>
        </div>
      </div>

      <div class="admin-body">
        <!-- LOJAS -->
        <div id="admin-tab-lojas">
          <div class="admin-list" id="admin-lojas-list"></div>
          <h3>Adicionar Loja</h3>
          <select id="admin-novo-formato">
            <option value="Hiper">Hiper</option>
            <option value="Super">Super</option>
            <option value="Prox">Prox</option>
            <option value="Servicos">Servi√ßos</option>
          </select>
          <div style="display:flex; gap:5px;">
            <input type="text" id="admin-nova-loja-cod" placeholder="Cod" maxlength="3" style="width: 80px;">
            <input type="text" id="admin-nova-loja-nome" placeholder="Nome da Loja" style="flex:1;">
          </div>
          <button onclick="adminAddLoja()">Adicionar Loja</button>
        </div>

        <!-- ASSISTENTES -->
        <div id="admin-tab-assistentes" style="display:none;">
          <div class="admin-list" id="admin-assistentes-list"></div>
          <h3 id="admin-ast-title">Adicionar Assistente</h3>
          <small style="display:block; margin-bottom:10px; color:#666;">Clica na lista acima para editar</small>

          <input type="text" id="admin-ast-label" placeholder="Nome no Bot√£o (Label)">
          <input type="text" id="admin-ast-url" placeholder="URL Destino">
          <textarea id="admin-ast-descricao" placeholder="Descri√ß√£o (obrigat√≥ria)"></textarea>

          <div style="display:flex; gap:5px; align-items:center;">
            <input type="text" id="admin-ast-icone" placeholder="Nome Imagem (ex: wally.jpg)" style="margin-bottom:0.8rem; flex:1;">
            <input type="file" id="admin-file-picker" style="display:none" onchange="selecionarImagemArquivo()">
            <button class="file-btn" onclick="document.getElementById('admin-file-picker').click()" style="margin-bottom:0.8rem;" title="Escolher ficheiro">üìÇ</button>
          </div>

          <div style="display:flex; gap:5px; margin-bottom: 0.8rem;">
            <select id="admin-ast-formato" style="margin-bottom:0;" onchange="atualizarSelectLojasAdmin()">
              <option value="">(Seleciona formato‚Ä¶)</option>
              <option value="*">Qualquer Formato (*)</option>
            </select>
            <select id="admin-ast-loja" style="margin-bottom:0;">
              <option value="">(Seleciona loja‚Ä¶)</option>
              <option value="*">Qualquer Loja (*)</option>
            </select>
          </div>

          <div style="display: flex; gap: 5px;">
            <button onclick="adminSaveAssistente()" id="btn-save-ast">Adicionar Assistente</button>
            <button onclick="cancelarEdicao()" id="btn-cancel-ast" class="cancel" style="display:none;">Cancelar</button>
          </div>
        </div>

        <!-- QRCODES -->
        <div id="admin-tab-qrcodes" style="display:none; text-align:left;">
          <p style="font-size:0.85rem; margin:0 0 12px 0;">
            Aqui escolhes Formato/Loja no Admin e imprimes o que for preciso, sem sair do painel.
          </p>

          <div class="version-control" style="margin-bottom:10px;">
            <label>Sele√ß√£o para impress√£o (Admin):</label>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
              <select id="admin-print-formato" style="margin-bottom:0;" onchange="atualizarLojasPrintAdmin_()"></select>
              <select id="admin-print-loja" style="margin-bottom:0;"></select>
            </div>

            <div style="display:flex; gap:10px;">
              <button type="button" class="secondary" onclick="usarSelecaoAppNoQRCodes_()" style="margin-bottom:0;">Usar sele√ß√£o da App</button>
              <button type="button" class="secondary" onclick="renderizarListaQRCodes_()" style="margin-bottom:0;">Atualizar lista</button>
            </div>

            <div style="margin-top:12px; font-size:0.85rem;">
              <div><span style="color:#666;">Sele√ß√£o atual:</span> <strong id="admin-qrcodes-selecao" style="color:#333;">...</strong></div>
              <div id="admin-qrcodes-warning" style="margin-top:6px; font-size:0.9rem;"></div>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
              <label style="display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;">
                <input type="checkbox" id="admin-qrcodes-selectall" />
                <span style="font-weight:800; color:#333;">Selecionar tudo</span>
              </label>
              <span id="admin-qrcodes-count" style="font-size:0.85rem; color:#666;">...</span>
            </div>

            <div id="admin-qrcodes-list"
                 style="margin-top:10px; max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:12px; background:#fafafa;">
            </div>
          </div>

          <button onclick="gerarPDFQRCodes()">üìÑ Gerar PDF QRCodes</button>
        </div>

        <!-- EXPORTAR -->
        <div id="admin-tab-exportar" style="display:none;">
          <p style="font-size: 0.85rem; margin-bottom: 10px;">
            Gera e baixa o ficheiro <b>config.js</b>. Depois, faz upload apenas deste ficheiro para o GitHub.
          </p>

          <div class="version-control">
            <label>Vers√£o Atual:</label>
            <strong id="lbl-versao-atual" style="color:#333;">...</strong>
            <br><br>
            <label>Nova Vers√£o (sugest√£o):</label>
            <input type="text" id="input-nova-versao" style="width: 100%; margin-bottom:0;" placeholder="Ex: v1.1.1">
          </div>

          <button onclick="baixarConfiguracao()">üì• Download Ficheiro de Configura√ß√£o</button>
          <button class="danger" onclick="limparTudoAdmin()">‚ö†Ô∏è Reset de F√°brica</button>
        </div>
      </div>

      <div class="admin-foot">
        <hr>
        <button class="secondary" onclick="fecharAdmin()">Fechar Admin</button>
      </div>
    </div>
  </div>

  <!-- MODAL: FECHAR ADMIN COM ALTERA√á√ïES -->
  <div id="admin-close-guard-overlay" class="overlay">
    <div class="overlay-box" style="width:min(520px,95%); text-align:left;">
      <span class="close-overlay-btn" onclick="fecharModalFechoAdmin_()">‚úï</span>
      <h2>‚ö†Ô∏è Altera√ß√µes por publicar</h2>
      <p style="margin-top:0; color:#666; font-size:.95rem; line-height:1.35;">
        Tens altera√ß√µes no Admin que ainda n√£o est√£o no <b>config.js</b> publicado.<br>
        Queres ir j√° ao separador <b>Guardar</b> para fazer download?
      </p>

      <div class="modal-actions">
        <button class="warn" onclick="irGuardarDoModal_()">Ir a Guardar</button>
        <button class="ghost" onclick="fecharSemAtualizarDoModal_()">Fechar sem atualizar</button>
        <button class="cancel" onclick="fecharModalFechoAdmin_()">Cancelar</button>
      </div>

      <p style="margin:10px 0 0 0; font-size:.8rem; color:#999;">
        (Sim, isto √© o teu ‚Äúare you sure?‚Äù corporativo üòÖ)
      </p>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="content-wrap">
      <img src="AibyAuchan.png" alt="AI by Auchan" class="logo" id="logo-trigger">
      <div class="loja-info">
        Loja: <span id="loja-nome">a definir‚Ä¶</span>
        <span class="change-store" onclick="forcarEscolhaLoja()">(alterar)</span>
      </div>
      <div class="grid"></div>
    </div>
    <div class="app-footer">
      <span class="help-link" onclick="document.getElementById('help-overlay').style.display='flex'">üì≤ Instalar App</span>
      <span id="app-footer-version" style="opacity:0.7">...</span>
    </div>
  </div>

  <script>
    /*************************************************
     * CONFIG / CONSTANTES
     *************************************************/
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeGFYjlrXC27y-a8sXgdnxKD4XzT8yImmL_0CZRXP26NwjQhQ/formResponse';
    const ENTRY_LOJA = 'entry.1749648688';
    const ENTRY_ASSISTENTE = 'entry.182917282';

    const FORMATO_KEY = 'formatoSelecionado';
    const LOJA_KEY = 'lojaSelecionada';

    const QR_PARAM_ASSISTENTE = 'assistente';
    const QR_PARAM_FORMATO = 'formato';
    const QR_PARAM_LOJA = 'loja';

    const ADMIN_PASSWORD = "9602";

    let STATE = { lojas: [], assistentes: [] };
    let editingAssistenteIndex = -1;

    // fallback caso config.js falhe
    const DADOS_PADRAO_FALLBACK = { lojas: [], assistentes: [] };

    /*************************************************
     * BOOT
     *************************************************/
    window.addEventListener('load', () => {
      carregarDados();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(console.log);
      }

      processarQRCodeParams();
    });

    /*************************************************
     * HELP TABS
     *************************************************/
    function switchHelpTab_(id) {
      document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
      const btn = document.querySelector(`.help-tab[data-htab="${id}"]`);
      if (btn) btn.classList.add('active');

      document.querySelectorAll('.help-panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(`help-panel-${id}`);
      if (panel) panel.classList.add('active');
    }

    /*************************************************
     * DADOS / STORAGE
     *************************************************/
    function carregarDados() {
      if (typeof DADOS_PADRAO === 'undefined') {
        console.warn("Ficheiro config.js n√£o encontrado.");
        window.DADOS_PADRAO = DADOS_PADRAO_FALLBACK;
        window.STORAGE_DATA_KEY = "appConfigData_v0.0";
      }

      const dadosLocais = localStorage.getItem(STORAGE_DATA_KEY);
      if (dadosLocais) STATE = JSON.parse(dadosLocais);
      else STATE = JSON.parse(JSON.stringify(DADOS_PADRAO));

      normalizarDescricoes();
      renderizarApp();
      atualizarVersaoRodape();
    }

    function guardarDadosLocais() {
      localStorage.setItem(STORAGE_DATA_KEY, JSON.stringify(STATE));
      renderizarApp();
    }

    function normalizarDescricoes() {
      if (!STATE || !Array.isArray(STATE.assistentes)) return;
      STATE.assistentes.forEach(a => {
        if (!a.descricao && a.desc) a.descricao = a.desc;
        if (!a.desc && a.descricao) a.desc = a.descricao;
      });
    }

    function atualizarVersaoRodape() {
      let versao = "Desconhecida";
      if (typeof STORAGE_DATA_KEY !== 'undefined') versao = STORAGE_DATA_KEY.split('_')[1] || 'vX.X';
      document.getElementById('app-footer-version').textContent = `Powered By G2G IAD3.0 ${String(versao).toUpperCase()}`;
    }

    /*************************************************
     * HELPERS
     *************************************************/
    function formatarTextoBonito(t) {
      if (!t || t === "*") return t;
      return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
    }

    function ordenarLojas(a, b) {
      return a.loja.localeCompare(b.loja, undefined, { numeric: true, sensitivity: 'base' });
    }

    function normKey_(s) {
      return (s || '').toString().trim().toLowerCase();
    }

    function deepClone_(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function sortAndNormalizeState_(src) {
      const out = deepClone_(src || { lojas: [], assistentes: [] });

      out.lojas = Array.isArray(out.lojas) ? out.lojas.map(l => ({
        formato: l.formato ? formatarTextoBonito(l.formato) : '',
        loja: (l.loja || '').trim()
      })) : [];

      out.assistentes = Array.isArray(out.assistentes) ? out.assistentes.map(a => ({
        formato: (a.formato || '').trim(),
        loja: (a.loja || '').trim(),
        nome: (a.nome || a.label || '').trim(),
        label: (a.label || a.nome || '').trim(),
        url: (a.url || '').trim(),
        icone: (a.icone || '').trim(),
        descricao: ((a.descricao || a.desc) || '').trim(),
        desc: ((a.descricao || a.desc) || '').trim()
      })) : [];

      out.lojas.sort((x, y) => (x.formato + ' - ' + x.loja).localeCompare(y.formato + ' - ' + y.loja, undefined, { numeric: true }));
      out.assistentes.sort((x, y) => (x.label || '').localeCompare((y.label || ''), undefined, { sensitivity: 'base' }));

      return out;
    }

    function hasUnpublishedChanges_() {
      if (typeof DADOS_PADRAO === 'undefined') return { changed: false, reason: 'no_published' };

      const pub = sortAndNormalizeState_(DADOS_PADRAO);
      const local = sortAndNormalizeState_(STATE);

      const pubStr = JSON.stringify(pub);
      const localStr = JSON.stringify(local);

      if (pubStr !== localStr) return { changed: true, reason: 'diff' };
      return { changed: false, reason: 'same' };
    }

    /*************************************************
     * APP UI
     *************************************************/
    function obterFormatosUnicos() {
      const raw = STATE.lojas.map(l => l.formato ? formatarTextoBonito(l.formato) : "");
      return [...new Set(raw)].filter(f => f !== "").sort();
    }

    function atualizarSelectFormato() {
      const s = document.getElementById('formato-select');
      const val = s.value;
      s.innerHTML = '<option value="" disabled selected>Seleciona o formato‚Ä¶</option>';
      obterFormatosUnicos().forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        s.appendChild(o);
      });
      if (val) s.value = val;
    }

    function atualizarSelectLojas() {
      const fmt = document.getElementById('formato-select').value;
      const s = document.getElementById('loja-select');
      s.innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      if (!fmt) return;

      const fmtN = fmt.toUpperCase();
      const ljs = STATE.lojas.filter(l => (l.formato || '').toUpperCase() === fmtN);
      ljs.sort(ordenarLojas);
      ljs.forEach(l => {
        const o = document.createElement('option');
        o.value = l.loja;
        o.textContent = l.loja;
        s.appendChild(o);
      });
    }

    function atualizarUILoja() {
      const f = localStorage.getItem(FORMATO_KEY);
      const l = localStorage.getItem(LOJA_KEY);
      const span = document.getElementById('loja-nome');
      const over = document.getElementById('loja-overlay');

      if (f && l) {
        span.textContent = `${formatarTextoBonito(f)} ‚Äì ${l}`;
        over.style.display = 'none';
        renderizarGridAssistentes(f, l);
      } else {
        span.textContent = 'a definir‚Ä¶';
        over.style.display = 'flex';
        document.querySelector('.grid').innerHTML = '';
      }
    }

    function renderizarApp() {
      atualizarSelectFormato();
      atualizarUILoja();
    }

    function fecharLojaOverlay() {
      document.getElementById('loja-overlay').style.display = 'none';
    }

    function filtrarAssistentesPorSelecao(uf, ul) {
      const ufN = (uf || '').toUpperCase();
      const ulN = (ul || '').toUpperCase();
      return STATE.assistentes.filter(a => {
        const f = (a.formato || '').toUpperCase();
        const l = (a.loja || '').toUpperCase();
        return (f === '*' || f === ufN) && (l === '*' || l === ulN);
      });
    }

    function renderizarGridAssistentes(uf, ul) {
      const grid = document.querySelector('.grid');
      grid.innerHTML = '';

      const matches = filtrarAssistentesPorSelecao(uf, ul)
        .slice()
        .sort((a, b) => (a.label || a.nome || '').localeCompare((b.label || b.nome || ''), undefined, { sensitivity: 'base' }));

      if (matches.length === 0) {
        grid.innerHTML = '<p style="grid-column: span 2; opacity: 0.7;">Nenhum assistente dispon√≠vel.</p>';
        return;
      }

      matches.forEach(a => {
        const btn = document.createElement('div');
        btn.className = 'btn';
        btn.onclick = () => abrirAssistente(a.nome || a.label, a.url);

        const img = document.createElement('img');
        img.src = a.icone || 'AibyAuchan.png';
        img.onerror = function() { this.src = 'AibyAuchan.png'; };

        const lbl = document.createElement('div');
        lbl.className = 'label';
        lbl.textContent = a.label || a.nome;

        btn.appendChild(img);
        btn.appendChild(lbl);
        grid.appendChild(btn);
      });
    }

    function guardarLoja() {
      const f = document.getElementById('formato-select').value;
      const l = document.getElementById('loja-select').value;
      if (!f || !l) return alert('Escolhe formato e loja.');
      localStorage.setItem(FORMATO_KEY, f);
      localStorage.setItem(LOJA_KEY, l);
      atualizarUILoja();
    }

    function forcarEscolhaLoja() {
      document.getElementById('formato-select').value = "";
      document.getElementById('loja-select').innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      document.getElementById('loja-overlay').style.display = 'flex';
    }

    function abrirAssistente(nomeAssistente, urlDestino) {
      const loja = localStorage.getItem(LOJA_KEY) || 'Sem loja';
      const p = new URLSearchParams();
      p.append(ENTRY_LOJA, loja);
      p.append(ENTRY_ASSISTENTE, nomeAssistente || 'Sem nome');

      fetch(FORM_BASE_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: p.toString()
      }).catch(() => {});

      window.open(urlDestino, '_blank');
    }

    /*************************************************
     * QR PARAMS (abrir direto por QR)
     *************************************************/
    function processarQRCodeParams() {
      const params = new URLSearchParams(window.location.search);
      if (!params.has(QR_PARAM_ASSISTENTE)) return;

      const assistenteParam = params.get(QR_PARAM_ASSISTENTE);
      const formatoParam = params.get(QR_PARAM_FORMATO);
      const lojaParam = params.get(QR_PARAM_LOJA);

      if (formatoParam) localStorage.setItem(FORMATO_KEY, formatoParam);
      if (lojaParam) localStorage.setItem(LOJA_KEY, lojaParam);

      const assistente = STATE.assistentes.find(a =>
        (a.nome === assistenteParam) || (a.label === assistenteParam)
      );

      if (!assistente) {
        alert("Assistente n√£o encontrado.");
        return;
      }

      const lojaFinal = lojaParam || localStorage.getItem(LOJA_KEY) || 'Sem loja';
      const payload = new URLSearchParams();
      payload.append(ENTRY_LOJA, lojaFinal);
      payload.append(ENTRY_ASSISTENTE, assistente.nome || assistente.label);

      const body = payload.toString();

      if (navigator.sendBeacon) {
        navigator.sendBeacon(FORM_BASE_URL, new Blob([body], { type: 'application/x-www-form-urlencoded' }));
        window.location.replace(assistente.url);
        return;
      }

      fetch(FORM_BASE_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body,
        keepalive: true
      }).finally(() => window.location.replace(assistente.url));
    }

    /*************************************************
     * ADMIN - LOGIN / OPEN / CLOSE
     *************************************************/
    let logoClicks = 0;
    document.getElementById('logo-trigger').addEventListener('click', () => {
      logoClicks++;
      if (logoClicks === 5) {
        logoClicks = 0;
        abrirLogin();
      }
    });

    function abrirLogin() {
      document.getElementById('login-overlay').style.display = 'flex';
      setTimeout(() => document.getElementById('login-password-input').focus(), 80);
    }

    function fecharLogin() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('login-password-input').value = '';
    }

    function verificarSenhaLogin() {
      if (document.getElementById('login-password-input').value === ADMIN_PASSWORD) {
        fecharLogin();
        abrirAdmin();
      } else {
        alert("Senha incorreta.");
      }
    }

    function abrirAdmin() {
      document.getElementById('admin-overlay').style.display = 'flex';
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();
      inicializarSelecaoPrintAdmin_();
      switchAdminTab('lojas');
    }

    // mant√©m admin aberto se houver altera√ß√µes locais vs publicado
    function fecharAdmin() {
      const diff = hasUnpublishedChanges_();
      if (diff.changed) {
        abrirModalFechoAdmin_();
        return;
      }
      fecharAdminSemPerguntar_();
    }

    function fecharAdminSemPerguntar_() {
      document.getElementById('admin-overlay').style.display = 'none';
      cancelarEdicao();
    }

    function abrirModalFechoAdmin_() {
      document.getElementById('admin-close-guard-overlay').style.display = 'flex';
    }
    function fecharModalFechoAdmin_() {
      document.getElementById('admin-close-guard-overlay').style.display = 'none';
    }
    function irGuardarDoModal_() {
      fecharModalFechoAdmin_();
      switchAdminTab('exportar');
    }
    function fecharSemAtualizarDoModal_() {
      fecharModalFechoAdmin_();
      fecharAdminSemPerguntar_();
    }

    function switchAdminTab(tabId) {
      document.querySelectorAll('.admin-tab').forEach(x => x.classList.remove('active'));
      const tabBtn = document.querySelector(`.admin-tab[data-tab="${tabId}"]`);
      if (tabBtn) tabBtn.classList.add('active');

      ['lojas','assistentes','qrcodes','exportar'].forEach(id => {
        const tab = document.getElementById(`admin-tab-${id}`);
        if (tab) tab.style.display = 'none';
      });

      const tabAtual = document.getElementById(`admin-tab-${tabId}`);
      if (tabAtual) tabAtual.style.display = 'block';

      if (tabId === 'assistentes') atualizarDropdownsAdminInicial();
      if (tabId === 'exportar') atualizarSugestaoVersao();
      if (tabId === 'qrcodes') renderizarListaQRCodes_();
    }

    /*************************************************
     * ADMIN - LISTAS (LOJAS / ASSISTENTES)
     *************************************************/
    function renderizarAdminListas() {
      const ll = document.getElementById('admin-lojas-list');
      ll.innerHTML = '';
      const lSorted = [...STATE.lojas].sort(ordenarLojas);

      lSorted.forEach(l => {
        const idx = STATE.lojas.indexOf(l);
        const d = document.createElement('div');
        d.className = 'admin-item';
        d.innerHTML = `
          <span>${formatarTextoBonito(l.formato)} - ${l.loja}</span>
          <button type="button" class="delete" onclick="adminRemoverLoja(${idx})" title="Apagar">X</button>
        `;
        ll.appendChild(d);
      });

      const al = document.getElementById('admin-assistentes-list');
      al.innerHTML = '';
      const aSorted = [...STATE.assistentes].sort((a, b) => (a.label || a.nome || '').localeCompare((b.label || b.nome || ''), undefined, { sensitivity: 'base' }));

      aSorted.forEach(a => {
        const idx = STATE.assistentes.indexOf(a);
        const d = document.createElement('div');
        d.className = 'admin-item';
        d.innerHTML = `
          <div class="admin-item-text" onclick="prepararEdicao(${idx})">
            ${(a.label || a.nome || '(sem nome)')}
            <small style="opacity:0.7">(${a.formato || '‚Äî'})(${a.loja || '‚Äî'})</small>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="dup" onclick="adminDuplicarAssistenteByIndex(${idx})" title="Duplicar">‚ßâ</button>
            <button type="button" class="delete" onclick="adminRemoverAssistenteByIndex(${idx})" title="Apagar">X</button>
          </div>
        `;
        al.appendChild(d);
      });
    }

    /*************************************************
     * ADMIN - LOJAS CRUD
     *************************************************/
    function adminAddLoja() {
      let f = document.getElementById('admin-novo-formato').value;
      const c = document.getElementById('admin-nova-loja-cod').value.trim();
      const n = document.getElementById('admin-nova-loja-nome').value.trim();
      if (!c || !n) return alert("Preenche c√≥digo e nome.");

      f = formatarTextoBonito(f);
      const lc = `${c}-${n}`;

      if (STATE.lojas.some(l => l.formato === f && l.loja === lc)) return alert("Loja j√° existe.");

      STATE.lojas.push({ formato: f, loja: lc });
      guardarDadosLocais();
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();
      inicializarSelecaoPrintAdmin_();

      document.getElementById('admin-nova-loja-cod').value = '';
      document.getElementById('admin-nova-loja-nome').value = '';
    }

    function adminRemoverLoja(i) {
      if (!confirm("Apagar?")) return;
      STATE.lojas.splice(i, 1);
      guardarDadosLocais();
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();
      inicializarSelecaoPrintAdmin_();
    }

    /*************************************************
     * ADMIN - ASSISTENTES CRUD
     *************************************************/
    function selecionarImagemArquivo() {
      const i = document.getElementById('admin-file-picker');
      if (i.files && i.files[0]) document.getElementById('admin-ast-icone').value = i.files[0].name;
    }

    function atualizarDropdownsAdminInicial() {
      const s = document.getElementById('admin-ast-formato');
      const prev = s.value;

      s.innerHTML = `
        <option value="">(Seleciona formato‚Ä¶)</option>
        <option value="*">Qualquer Formato (*)</option>
      `;

      obterFormatosUnicos().forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        s.appendChild(o);
      });

      if (prev !== undefined && prev !== null) s.value = prev;
      atualizarSelectLojasAdmin();
    }

    function atualizarSelectLojasAdmin() {
      const sf = document.getElementById('admin-ast-formato');
      const sl = document.getElementById('admin-ast-loja');
      const prev = sl.value;

      sl.innerHTML = `
        <option value="">(Seleciona loja‚Ä¶)</option>
        <option value="*">Qualquer Loja (*)</option>
      `;

      let list = [];
      if (sf.value === '*') list = [...STATE.lojas];
      else if (sf.value === '') list = [];
      else list = STATE.lojas.filter(l => (l.formato || '').toUpperCase() === sf.value.toUpperCase());

      list.sort(ordenarLojas);
      list.forEach(l => {
        const o = document.createElement('option');
        o.value = l.loja;
        o.textContent = l.loja;
        sl.appendChild(o);
      });

      if (Array.from(sl.options).some(o => o.value === prev)) sl.value = prev;
    }

    function prepararEdicao(i) {
      editingAssistenteIndex = i;
      const a = STATE.assistentes[i];

      document.getElementById('admin-ast-label').value = a.label || '';
      document.getElementById('admin-ast-url').value = a.url || '';
      document.getElementById('admin-ast-icone').value = a.icone || '';
      document.getElementById('admin-ast-descricao').value = (a.descricao || a.desc || '') || '';

      document.getElementById('admin-ast-formato').value = a.formato ? formatarTextoBonito(a.formato) : '';
      atualizarSelectLojasAdmin();
      document.getElementById('admin-ast-loja').value = a.loja || '';

      document.getElementById('admin-ast-title').innerText = "Editar Assistente";
      document.getElementById('btn-save-ast').innerText = "Atualizar";
      document.getElementById('btn-cancel-ast').style.display = "block";
    }

    function cancelarEdicao() {
      editingAssistenteIndex = -1;

      ['admin-ast-label','admin-ast-url','admin-ast-icone','admin-ast-descricao'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      document.getElementById('admin-ast-formato').value = '';
      atualizarSelectLojasAdmin();

      document.getElementById('admin-ast-title').innerText = "Adicionar Assistente";
      document.getElementById('btn-save-ast').innerText = "Adicionar Assistente";
      document.getElementById('btn-cancel-ast').style.display = "none";
    }

    function scopesOverlap_(a, b) {
      const af = ((a && a.formato) ?? '').toString().trim().toUpperCase();
      const bf = ((b && b.formato) ?? '').toString().trim().toUpperCase();
      const al = ((a && a.loja) ?? '').toString().trim().toUpperCase();
      const bl = ((b && b.loja) ?? '').toString().trim().toUpperCase();

      if (!af || !al || !bf || !bl) return false;

      const fmtOverlap = (af === '*') || (bf === '*') || (af === bf);
      const lojaOverlap = (al === '*') || (bl === '*') || (al === bl);

      return fmtOverlap && lojaOverlap;
    }

    function isGlobalScope_(a) {
      const f = ((a && a.formato) ?? '').toString().trim().toUpperCase();
      const l = ((a && a.loja) ?? '').toString().trim().toUpperCase();
      return f === '*' && l === '*';
    }

    function gerarLabelCopiaUnica_(base) {
      let candidate = base;
      let n = 2;
      const exists = (lbl) => STATE.assistentes.some(a => normKey_(a.label) === normKey_(lbl));
      while (exists(candidate)) {
        candidate = `${base} ${n}`;
        n++;
      }
      return candidate;
    }

    function validarConflitosAssistente_(novo, editingIdx) {
      const nf = ((novo.formato ?? '') + '').trim();
      const nl = ((novo.loja ?? '') + '').trim();
      if (!nf || !nl) return null;

      const novoKey = normKey_(novo.label || novo.nome);
      if (!novoKey) return null;

      for (let idx = 0; idx < STATE.assistentes.length; idx++) {
        if (idx === editingIdx) continue;
        const a = STATE.assistentes[idx];

        const aKey = normKey_(a.label || a.nome);
        if (aKey !== novoKey) continue;

        if (!scopesOverlap_(novo, a)) continue;

        const aGlobal = isGlobalScope_(a);
        const novoGlobal = isGlobalScope_(novo);

        if (aGlobal && !novoGlobal) {
          return `J√° existe um assistente GERAL (*)(*) com o nome "${novo.label || novo.nome}". N√£o podes criar vers√µes mais espec√≠ficas com o mesmo nome.`;
        }
        if (!aGlobal && novoGlobal) {
          return `J√° existem vers√µes espec√≠ficas do assistente "${novo.label || novo.nome}". N√£o podes criar uma vers√£o GERAL (*)(*) com o mesmo nome.`;
        }
        return `Conflito: j√° existe um assistente com este nome cujo escopo se sobrep√µe.`;
      }

      return null;
    }

    function adminSaveAssistente() {
      const l = document.getElementById('admin-ast-label').value.trim();
      const n = l;
      const u = document.getElementById('admin-ast-url').value.trim();
      const ic = document.getElementById('admin-ast-icone').value.trim();
      const d = document.getElementById('admin-ast-descricao').value.trim();

      let f = (document.getElementById('admin-ast-formato').value ?? '').toString().trim();
      let loj = (document.getElementById('admin-ast-loja').value ?? '').toString().trim();

      if (!l || !u) return alert("Falta Nome ou URL");
      if (!d) return alert("A descri√ß√£o √© obrigat√≥ria (para o PDF).");
      if (!f || !loj) return alert('Escolhe Formato e Loja (podes usar "*").');

      if (f !== '*') f = formatarTextoBonito(f);

      const novo = {
        formato: f,
        loja: loj,
        nome: n,
        label: l,
        url: u,
        icone: ic,
        descricao: d,
        desc: d
      };

      const conflito = validarConflitosAssistente_(novo, editingAssistenteIndex);
      if (conflito) return alert(conflito);

      const dupExato = STATE.assistentes.some((a, idx) => {
        if (idx === editingAssistenteIndex) return false;
        return (
          normKey_(a.label || a.nome) === normKey_(novo.label || novo.nome) &&
          normKey_(a.url) === normKey_(novo.url) &&
          ((a.formato || '') === (novo.formato || '')) &&
          ((a.loja || '') === (novo.loja || ''))
        );
      });
      if (dupExato) return alert("Assistente duplicado!");

      if (editingAssistenteIndex >= 0) STATE.assistentes[editingAssistenteIndex] = novo;
      else STATE.assistentes.push(novo);

      guardarDadosLocais();
      renderizarAdminListas();
      cancelarEdicao();

      const qrtab = document.getElementById('admin-tab-qrcodes');
      if (qrtab && qrtab.style.display === 'block') renderizarListaQRCodes_();
    }

    function adminRemoverAssistenteByIndex(i) {
      if (!Number.isInteger(i) || !STATE.assistentes[i]) return;
      if (!confirm("Apagar?")) return;

      STATE.assistentes.splice(i, 1);
      guardarDadosLocais();
      renderizarAdminListas();

      if (editingAssistenteIndex === i) cancelarEdicao();

      const qrtab = document.getElementById('admin-tab-qrcodes');
      if (qrtab && qrtab.style.display === 'block') renderizarListaQRCodes_();
    }

    function adminDuplicarAssistenteByIndex(i) {
      const src = STATE.assistentes[i];
      if (!src) return;

      const baseLabel = (src.label || src.nome || 'Assistente') + ' (c√≥pia)';

      const clone = {
        ...src,
        nome: src.nome || src.label,
        label: gerarLabelCopiaUnica_(baseLabel),
        formato: '',
        loja: ''
      };

      STATE.assistentes.push(clone);
      guardarDadosLocais();
      renderizarAdminListas();
      prepararEdicao(STATE.assistentes.length - 1);
    }

    /*************************************************
     * EXPORTAR CONFIG.JS
     *************************************************/
    function atualizarSugestaoVersao() {
      let v = "1.0";
      if (typeof STORAGE_DATA_KEY !== 'undefined') v = STORAGE_DATA_KEY.split('_v')[1] || "1.0";

      document.getElementById('lbl-versao-atual').textContent = "v" + v;

      let p = v.split('.').map(Number);
      if (p.length === 2) p.push(0);
      p[p.length - 1]++;

      document.getElementById('input-nova-versao').value = "v" + p.join('.');
    }

    function baixarConfiguracao() {
      let vUser = document.getElementById('input-nova-versao').value.trim();
      if (vUser.startsWith('v')) vUser = vUser.substring(1);

      const newKey = "appConfigData_v" + vUser;

      STATE.lojas.forEach(l => { if (l.formato) l.formato = formatarTextoBonito(l.formato); });
      STATE.assistentes.forEach(a => {
        if (a.formato && a.formato !== '*') a.formato = formatarTextoBonito(a.formato);
        const dd = (a.descricao || a.desc || '').trim();
        a.descricao = dd;
        a.desc = dd;
      });

      STATE.lojas.sort(ordenarLojas);
      STATE.assistentes.sort((a, b) => (a.label || a.nome || '').localeCompare((b.label || b.nome || ''), undefined, { sensitivity: 'base' }));

      let content = `// Ficheiro de Configura√ß√£o Gerado Automaticamente\n`;
      content += `const STORAGE_DATA_KEY = "${newKey}";\n\n`;
      content += `const DADOS_PADRAO = {\n`;
      content += `  lojas: [\n`;
      STATE.lojas.forEach((l, idx) => {
        let line = JSON.stringify(l);
        if (idx < STATE.lojas.length - 1) line += ",";
        content += `    ${line}\n`;
      });
      content += `  ],\n`;
      content += `  assistentes: [\n`;
      STATE.assistentes.forEach((a, idx) => {
        let block = JSON.stringify(a, null, 4);
        block = block.split('\n').map(line => "    " + line).join('\n');
        if (idx < STATE.assistentes.length - 1) block += ",";
        content += `${block}\n`;
      });
      content += `  ]\n`;
      content += `};\n`;

      const blob = new Blob([content], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "config.js";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert("Ficheiro config.js baixado!\nFaz upload dele para a pasta do GitHub.");
    }

    function limparTudoAdmin() {
      if (!confirm("Resetar F√°brica?")) return;
      localStorage.removeItem(STORAGE_DATA_KEY);
      location.reload();
    }

    /*************************************************
     * QRCODES - SELE√á√ÉO ADMIN
     * - sem op√ß√£o (*) nos dropdowns (s√≥ lojas reais)
     *************************************************/
    const PRINT_APP_VALUE = '__APP__';

    function inicializarSelecaoPrintAdmin_() {
      const sf = document.getElementById('admin-print-formato');
      const sl = document.getElementById('admin-print-loja');
      if (!sf || !sl) return;

      const prevF = sf.value || PRINT_APP_VALUE;
      sf.innerHTML = '';

      const optAppF = document.createElement('option');
      optAppF.value = PRINT_APP_VALUE;
      optAppF.textContent = '(usar sele√ß√£o da App)';
      sf.appendChild(optAppF);

      obterFormatosUnicos().forEach(f => {
        if (!f || f === '*') return;
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        sf.appendChild(o);
      });

      sf.value = prevF;
      atualizarLojasPrintAdmin_();
    }

    function atualizarLojasPrintAdmin_() {
      const sf = document.getElementById('admin-print-formato');
      const sl = document.getElementById('admin-print-loja');
      if (!sf || !sl) return;

      const prevL = sl.value || PRINT_APP_VALUE;
      sl.innerHTML = '';

      const optAppL = document.createElement('option');
      optAppL.value = PRINT_APP_VALUE;
      optAppL.textContent = '(usar sele√ß√£o da App)';
      sl.appendChild(optAppL);

      if (sf.value === PRINT_APP_VALUE) {
        sl.value = PRINT_APP_VALUE;
        return;
      }

      const fmt = sf.value;
      const lojas = STATE.lojas
        .filter(l => (l.formato || '').toUpperCase() === String(fmt).toUpperCase())
        .filter(l => (l.loja || '').trim() !== '*' && (l.loja || '').trim() !== 'Qualquer Loja (*)')
        .slice()
        .sort(ordenarLojas);

      lojas.forEach(l => {
        const o = document.createElement('option');
        o.value = l.loja;
        o.textContent = l.loja;
        sl.appendChild(o);
      });

      if (Array.from(sl.options).some(o => o.value === prevL)) sl.value = prevL;
      else sl.value = PRINT_APP_VALUE;
    }

    function usarSelecaoAppNoQRCodes_() {
      const sf = document.getElementById('admin-print-formato');
      const sl = document.getElementById('admin-print-loja');
      if (!sf || !sl) return;

      sf.value = PRINT_APP_VALUE;
      sl.value = PRINT_APP_VALUE;
      renderizarListaQRCodes_();
    }

function obterSelecaoEfetivaQRCodes_() {
  const sf = document.getElementById('admin-print-formato');
  const sl = document.getElementById('admin-print-loja');

  const appF = localStorage.getItem(FORMATO_KEY);
  const appL = localStorage.getItem(LOJA_KEY);

  const f = (sf && sf.value && sf.value !== PRINT_APP_VALUE) ? sf.value : (appF || '');
  const l = (sl && sl.value && sl.value !== PRINT_APP_VALUE) ? sl.value : (appL || '');

  const origem = ((sf && sf.value !== PRINT_APP_VALUE) || (sl && sl.value !== PRINT_APP_VALUE)) ? 'Admin' : 'App';
  return { formato: f, loja: l, origem };
}


    /*************************************************
     * QRCODES - COMPARA√á√ÉO VS PUBLICADO
     *************************************************/
    function mapPublishedByUrl_() {
      const m = new Map();
      const pub = (typeof DADOS_PADRAO !== 'undefined' && DADOS_PADRAO && Array.isArray(DADOS_PADRAO.assistentes))
        ? DADOS_PADRAO.assistentes
        : [];

      pub.forEach(a => {
        const url = (a.url || '').trim();
        const key = url ? `U:${normKey_(url)}` : `N:${normKey_(a.label || a.nome)}`;
        const desc = ((a.descricao || a.desc) || '').toString().trim();
        if (!m.has(key)) m.set(key, desc);
        if (m.get(key) === '' && desc) m.set(key, desc);
      });

      return m;
    }

    function getRowStatus_(assistente, pubMap) {
      const url = (assistente.url || '').trim();
      const key = url ? `U:${normKey_(url)}` : `N:${normKey_(assistente.label || assistente.nome)}`;

      const localDesc = ((assistente.descricao || assistente.desc) || '').toString().trim();
      const pubHas = pubMap.has(key);

      if (!pubHas) return { status: 'novo' };
      const pubDesc = (pubMap.get(key) || '').toString().trim();

      if (pubDesc !== localDesc) return { status: 'alterado' };
      return { status: 'ok' };
    }

    function contarAlteracoes_(candidatos, pubMap) {
      const seen = new Set();
      let count = 0;

      candidatos.forEach(a => {
        const url = (a.url || '').trim();
        const key = url ? `U:${normKey_(url)}` : `N:${normKey_(a.label || a.nome)}`;
        if (seen.has(key)) return;
        seen.add(key);

        const st = getRowStatus_(a, pubMap).status;
        if (st === 'novo' || st === 'alterado') count++;
      });

      return count;
    }

    /*************************************************
     * QRCODES - RENDER LISTA (checkbox √† direita + fundo se alterado)
     *************************************************/
function renderizarListaQRCodes_() {
  const selecao = document.getElementById('admin-qrcodes-selecao');
  const warning = document.getElementById('admin-qrcodes-warning');
  const list = document.getElementById('admin-qrcodes-list');
  const selectAll = document.getElementById('admin-qrcodes-selectall');
  const count = document.getElementById('admin-qrcodes-count');

  if (!selecao || !warning || !list || !selectAll || !count) return;

  const sel = obterSelecaoEfetivaQRCodes_(); // <-- agora existe
  const { formato, loja, origem } = sel;

  if (!formato || !loja) {
    selecao.textContent = 'Sem sele√ß√£o';
    warning.innerHTML = `<span style="color:#d63a3e; font-weight:900;">Escolhe formato e loja (na App ou aqui no Admin) antes de gerar o PDF.</span>`;
    list.innerHTML = '';
    count.textContent = '';
    selectAll.checked = false;
    selectAll.indeterminate = false;
    selectAll.disabled = true;
    return;
  }

  selecao.textContent = `${formatarTextoBonito(formato)} ‚Äì ${loja} (${origem})`;

  const ufN = (formato || '').toUpperCase();
  const ulN = (loja || '').toUpperCase();

  const candidatos = STATE.assistentes
    .map((a, idx) => ({ ...a, __index: idx }))
    .filter(a => {
      const f = (a.formato || '').toUpperCase();
      const l = (a.loja || '').toUpperCase();
      return (f === '*' || f === ufN) && (l === '*' || l === ulN);
    })
    .sort((a, b) => (a.label || a.nome || '').localeCompare((b.label || b.nome || ''), undefined, { sensitivity: 'base' }));

  const pubMap = mapPublishedByUrl_();
  const changesCount = contarAlteracoes_(candidatos, pubMap);

  if (changesCount > 0) {
    warning.innerHTML = `<span style="color:#d63a3e; font-weight:900;">‚ö†Ô∏è Existem ${changesCount} descri√ß√µes novas/alteradas face ao publicado. Depois imprime e vai √† aba <b>Guardar</b> fazer download do <b>config.js</b>.</span>`;
  } else {
    warning.innerHTML = `<span style="color:#2e7d32; font-weight:900;">‚úÖ Tudo sincronizado com a vers√£o publicada.</span>`;
  }

  count.textContent = `${candidatos.length} assistente(s)`;

  if (candidatos.length === 0) {
    list.innerHTML = `<div style="padding:12px; color:#666;">Nenhum assistente dispon√≠vel para esta sele√ß√£o.</div>`;
    selectAll.checked = false;
    selectAll.indeterminate = false;
    selectAll.disabled = true;
    return;
  }

  selectAll.disabled = false;

  // Importante: o layout da row passa a usar "auto 1fr auto auto"
  list.innerHTML = candidatos.map(a => {
    const img = (a.icone || 'AibyAuchan.png');
    const label = (a.label || a.nome || '').trim();
    const scope = `${(a.formato ? formatarTextoBonito(a.formato) : '‚Äî')} ¬∑ ${(a.loja || '‚Äî')}`;

    const st = getRowStatus_(a, pubMap).status;
    const rowClass =
      st === 'alterado' ? 'qr-row badge-alterado' :
      st === 'novo' ? 'qr-row badge-novo' : 'qr-row';

    const badgeHtml =
      st === 'alterado' ? `<span class="qr-badge alterado">‚ö†Ô∏è Alterado</span>` :
      st === 'novo' ? `<span class="qr-badge novo">üÜï Novo</span>` : ``;

    return `
      <label class="${rowClass}" style="
        display:grid;
        grid-template-columns: 44px 1fr auto 22px;
        align-items:center;
        column-gap:12px;
      ">
        <img src="${img}" onerror="this.src='AibyAuchan.png'"
             style="width:38px; height:38px; object-fit:cover; border-radius:10px; border:1px solid #eee;" />

        <div style="min-width:0;">
          <div style="font-weight:900; color:#333; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            ${label}
          </div>
          <div style="font-size:0.8rem; color:#666; line-height:1.2;">
            ${scope}
          </div>
        </div>

        <div style="justify-self:end;">
          ${badgeHtml}
        </div>

        <input type="checkbox" class="qr-ast-check" data-idx="${a.__index}" checked
               style="width:18px; height:18px; justify-self:end; margin:0;" />
      </label>
    `;
  }).join('');

  // select-all
  selectAll.checked = true;
  selectAll.indeterminate = false;

  selectAll.onchange = () => {
    const cbs = list.querySelectorAll('input.qr-ast-check');
    cbs.forEach(cb => cb.checked = selectAll.checked);
    selectAll.indeterminate = false;
  };

  if (!list.dataset.boundChange) {
    list.dataset.boundChange = '1';
    list.addEventListener('change', () => {
      const cbs = [...list.querySelectorAll('input.qr-ast-check')];
      const allOn = cbs.length > 0 && cbs.every(cb => cb.checked);
      const anyOn = cbs.some(cb => cb.checked);

      selectAll.indeterminate = anyOn && !allOn;
      selectAll.checked = allOn;
    }, { passive: true });
  }
}

    /*************************************************
     * QRCODES - MODAL DESCRI√á√ïES EM FALTA
     *************************************************/
    function garantirModalDescricao() {
      if (document.getElementById('missing-desc-overlay')) return;

      const overlay = document.createElement('div');
      overlay.id = 'missing-desc-overlay';
      overlay.className = 'overlay';
      overlay.innerHTML = `
        <div class="overlay-box" style="width:min(520px,95%); text-align:left;">
          <span class="close-overlay-btn" onclick="document.getElementById('missing-desc-overlay').style.display='none'">‚úï</span>
          <h2>Faltam descri√ß√µes üòÖ</h2>
          <p style="margin-top:0; font-size:.9rem; color:#666;">
            Preenche as descri√ß√µes em falta. Sem isso, n√£o d√° para gerar o PDF.
          </p>
          <div id="missing-desc-list" style="max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa;"></div>
          <div style="display:flex; gap:10px; margin-top:12px;">
            <button onclick="window.__missingDescSaveAndContinue()">Guardar e Continuar</button>
            <button class="secondary" onclick="document.getElementById('missing-desc-overlay').style.display='none'">Cancelar</button>
          </div>
          <div id="missing-desc-error" style="margin-top:10px; font-size:.85rem; color:#d63a3e; font-weight:600;"></div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function abrirModalDescricaoEmFalta(lista, onDone) {
      garantirModalDescricao();

      const overlay = document.getElementById('missing-desc-overlay');
      const list = document.getElementById('missing-desc-list');
      const err = document.getElementById('missing-desc-error');

      err.textContent = '';
      list.innerHTML = lista.map(a => `
        <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #eee;">
          <div style="font-weight:700; color:#333; margin-bottom:6px;">
            ${(a.label || a.nome || '(sem nome)')}
          </div>
          <textarea
            data-missing-desc="1"
            data-ast-index="${a.__index}"
            placeholder="Descri√ß√£o (2-3 linhas)"
            style="width:100%; box-sizing:border-box; padding:.6rem; border-radius:10px; border:1px solid #ccc; min-height:72px; resize:vertical;"
          >${((a.descricao || a.desc || '') + '').trim()}</textarea>
        </div>
      `).join('');

      window.__missingDescSaveAndContinue = function () {
        err.textContent = '';
        const tas = [...list.querySelectorAll('textarea[data-missing-desc="1"]')];
        const faltam = tas.some(ta => !(ta.value || '').trim());

        if (faltam) {
          err.textContent = 'Ainda faltam descri√ß√µes. Preenche tudo para continuar.';
          return;
        }

        tas.forEach(ta => {
          const idx = Number(ta.getAttribute('data-ast-index'));
          const val = (ta.value || '').trim();
          if (Number.isNaN(idx) || !STATE.assistentes[idx]) return;

          const ref = STATE.assistentes[idx];
          const refUrl = (ref.url || '').trim();

          ref.descricao = val;
          ref.desc = val;

          if (refUrl) {
            STATE.assistentes.forEach(a => {
              if (((a.url || '').trim()) === refUrl) {
                a.descricao = val;
                a.desc = val;
              }
            });
          }
        });

        guardarDadosLocais();
        overlay.style.display = 'none';
        if (onDone) onDone();
      };

      overlay.style.display = 'flex';
    }


/*************************************************
 * PDF HELPERS (SUBSTITUI TUDO O QUE TENS AQUI)
 *************************************************/
function carregarScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Falha ao carregar biblioteca: ' + src));
    document.head.appendChild(s);
  });
}

async function garantirPdfLib() {
  if (window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
  await carregarScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
  return window.jspdf.jsPDF;
}

/**
 * ‚úÖ QR lib robusta:
 * - tenta global (se j√° existir)
 * - sen√£o usa ESM via import() com v√°rios CDNs
 */
async function garantirQrLib_() {
  // cache interno
  if (window.__QR_LIB__ && typeof window.__QR_LIB__.toCanvas === 'function') return window.__QR_LIB__;

  // caso j√° exista global (de outra tentativa)
  if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
    window.__QR_LIB__ = window.QRCode;
    return window.__QR_LIB__;
  }

  const candidates = [
    'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm',
    'https://cdn.jsdelivr.net/npm/qrcode@1.5.4/+esm',
    'https://esm.sh/qrcode@1.5.3',
    'https://cdn.skypack.dev/qrcode'
  ];

  let lastErr = null;

  for (const url of candidates) {
    try {
      const mod = await import(url);
      const QR = mod?.default || mod;

      if (QR && typeof QR.toCanvas === 'function') {
        window.__QR_LIB__ = QR;
        // opcional: tamb√©m exp√µe em window.QRCode para debug
        window.QRCode = QR;
        return QR;
      }
      lastErr = new Error('Lib carregou mas n√£o tem toCanvas: ' + url);
    } catch (e) {
      lastErr = e;
    }
  }

  throw new Error('N√£o foi poss√≠vel carregar a biblioteca de QRCode com toCanvas. √öltimo erro: ' + (lastErr?.message || lastErr));
}

function criarUrlQRCode(assistente, formato, loja) {
  const base = `${window.location.origin}${window.location.pathname}`;
  const params = new URLSearchParams();
  params.set(QR_PARAM_ASSISTENTE, assistente.nome || assistente.label);
  if (formato) params.set(QR_PARAM_FORMATO, formato);
  if (loja) params.set(QR_PARAM_LOJA, loja);
  return `${base}?${params.toString()}`;
}

async function carregarImagemComoDataURL(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';

    img.onload = () => {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      } catch (e) {
        reject(e);
      }
    };

    img.onerror = () => reject(new Error('Falha ao carregar imagem: ' + src));
    img.src = src;
  });
}

/**
 * Gera QR PNG com logo ao centro (com patch branco por tr√°s)
 */
async function gerarQRCodeComLogoDataURL_(texto, logoSrc) {
  const QR = await garantirQrLib_();
  const size = 700;

  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;

  await QR.toCanvas(canvas, texto, {
    errorCorrectionLevel: 'H',
    margin: 2,
    width: size
  });

  const ctx = canvas.getContext('2d');

  // carrega logo como dataURL para evitar "canvas tainted"
  let logoDataUrl = null;
  try {
    logoDataUrl = await carregarImagemComoDataURL(logoSrc);
  } catch (e) {
    console.warn('Logo n√£o carregou, QR sem logo:', e);
    return canvas.toDataURL('image/png');
  }

  const logo = new Image();
  await new Promise((resolve, reject) => {
    logo.onload = resolve;
    logo.onerror = reject;
    logo.src = logoDataUrl;
  });

  const logoSize = Math.round(size * 0.18); // ~18%
  const x = (size - logoSize) / 2;
  const y = (size - logoSize) / 2;

  // patch branco por tr√°s do logo (para legibilidade)
  const pad = Math.round(logoSize * 0.18);
  const rx = x - pad;
  const ry = y - pad;
  const rw = logoSize + pad * 2;
  const rh = logoSize + pad * 2;

  const r = Math.round(logoSize * 0.2);
  ctx.save();
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.moveTo(rx + r, ry);
  ctx.arcTo(rx + rw, ry, rx + rw, ry + rh, r);
  ctx.arcTo(rx + rw, ry + rh, rx, ry + rh, r);
  ctx.arcTo(rx, ry + rh, rx, ry, r);
  ctx.arcTo(rx, ry, rx + rw, ry, r);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  ctx.drawImage(logo, x, y, logoSize, logoSize);

  return canvas.toDataURL('image/png');
}

/*************************************************
 * GERAR PDF (SUBSTITUI A TUA FUN√á√ÉO gerarPDFQRCodes)
 *************************************************/
async function gerarPDFQRCodes() {
  try {
    const { formato, loja } = obterSelecaoEfetivaQRCodes_();
    if (!formato || !loja) {
      alert('Seleciona formato e loja (na App ou aqui no Admin) antes de gerar o PDF.');
      return;
    }

    const list = document.getElementById('admin-qrcodes-list');
    if (!list) {
      alert('Abre o separador QRCodes primeiro.');
      return;
    }

    const selectedIdxs = [...list.querySelectorAll('input.qr-ast-check:checked')]
      .map(cb => Number(cb.getAttribute('data-idx')))
      .filter(n => !Number.isNaN(n));

    if (selectedIdxs.length === 0) {
      alert('Seleciona pelo menos 1 assistente para imprimir.');
      return;
    }

    const setSel = new Set(selectedIdxs);

    const assistentes = STATE.assistentes
      .map((a, idx) => ({ ...a, __index: idx }))
      .filter(a => setSel.has(a.__index))
      .sort((a, b) => (a.label || a.nome || '').localeCompare((b.label || b.nome || ''), undefined, { sensitivity: 'base' }));

    const semDescricao = assistentes.filter(a => !((a.descricao || a.desc || '').trim()));
    if (semDescricao.length) {
      abrirModalDescricaoEmFalta(semDescricao, () => gerarPDFQRCodes());
      return;
    }

    const jsPDF = await garantirPdfLib();
    const doc = new jsPDF({ format: 'a5', unit: 'mm' });

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 10;

    const imageWidth = pageWidth - (margin * 2);
    const imageHeight = imageWidth;

    const yAfterImage = margin + imageHeight + 6;
    const usableBottom = pageHeight - margin;

    const lojaLabel = `${formatarTextoBonito(formato)} ‚Äì ${loja}`;

    const minQr = 42;        // mm
    const maxQr = 70;        // mm
    const storeLineH = 6;    // mm
    const gap1 = 6;
    const gap2 = 6;

    // espa√ßo para descri√ß√£o (garante sempre QR m√≠nimo + rodap√©)
    const available = usableBottom - yAfterImage;
    const descMax = Math.max(18, available - minQr - storeLineH - gap1 - gap2);

    const diff = hasUnpublishedChanges_();

    for (let idx = 0; idx < assistentes.length; idx++) {
      const a = assistentes[idx];
      if (idx > 0) doc.addPage('a5', 'p');

      // IMAGEM do assistente
      const imgSrc = a.icone || 'AibyAuchan.png';
      let imgData = null;
      try { imgData = await carregarImagemComoDataURL(imgSrc); }
      catch { imgData = await carregarImagemComoDataURL('AibyAuchan.png'); }

      // URL do QR
      const qrUrl = criarUrlQRCode(a, formatarTextoBonito(formato), loja);

      // QR com logo
      let qrData = null;
      try {
        qrData = await gerarQRCodeComLogoDataURL_(qrUrl, 'AibyAuchan.png');
      } catch (e) {
        console.warn('QR com logo falhou, a tentar sem logo...', e);
        const QR = await garantirQrLib_();
        const c = document.createElement('canvas');
        c.width = 700; c.height = 700;
        await QR.toCanvas(c, qrUrl, { errorCorrectionLevel: 'H', margin: 2, width: 700 });
        qrData = c.toDataURL('image/png');
      }

      // 1) IMAGEM (quadrada)
      doc.addImage(imgData, 'PNG', margin, margin, imageWidth, imageHeight);

      // 2) DESCRI√á√ÉO (n√£o invade o QR)
      const descricao = (a.descricao || a.desc || '').trim();
      doc.setTextColor(0);
      doc.setFontSize(11);

      const descX = margin;
      const descY = yAfterImage;
      const descW = imageWidth;

      let lines = doc.splitTextToSize(descricao, descW);
      let lineH = 4.8;

      // reduz fonte se for gigante
      if ((lines.length * lineH) > descMax) {
        doc.setFontSize(10);
        lines = doc.splitTextToSize(descricao, descW);
        lineH = 4.5;
      }

      // corta at√© caber
      while ((lines.length * lineH + 4) > descMax && lines.length > 2) {
        lines.pop();
        lines[lines.length - 1] = `${lines[lines.length - 1].replace(/\s*$/, '')}‚Ä¶`;
      }

      const textStartY = descY + 4;
      doc.text(lines, descX, textStartY);

      // altura real usada pela descri√ß√£o (offset + linhas)
      const descUsedH = Math.min(descMax, 4 + (lines.length * lineH));
      const yAfterDesc = descY + descUsedH;

      // 3) QR por baixo da descri√ß√£o ‚Äî e NUNCA invade o rodap√©
      const footerY = usableBottom;
      const footerReserve = storeLineH + gap2;
      const maxQrBottomY = footerY - footerReserve;

      const qrTopY = yAfterDesc + gap1;
      let qrSize = Math.min(maxQr, (maxQrBottomY - qrTopY));
      qrSize = Math.max(minQr, qrSize);

      // √∫ltimo recurso: se mesmo assim n√£o cabe, encolhe mais (mas sem ficar rid√≠culo)
      if (qrTopY + qrSize > maxQrBottomY) {
        qrSize = Math.max(28, maxQrBottomY - qrTopY);
      }

      const qrX = (pageWidth - qrSize) / 2;
      const qrY = qrTopY;

      doc.addImage(qrData, 'PNG', qrX, qrY, qrSize, qrSize);

      // 4) Rodap√© loja (sempre fora do QR)
      doc.setFontSize(10);
      doc.setTextColor(60);
      doc.text(lojaLabel, pageWidth / 2, footerY, { align: 'center' });
    }

    if (diff.changed) {
      alert('‚ö†Ô∏è Aten√ß√£o: existem altera√ß√µes por publicar.\nDepois de imprimires, vai √† aba Guardar e faz download do config.js para atualizar a app.');
    }

    doc.save(`qrcodes_${formatarTextoBonito(formato)}_${loja}.pdf`);
  } catch (error) {
    console.error('PDF ERROR:', error);
    const detalhe = (error && (error.message || String(error))) || 'Erro desconhecido';
    alert('Falhou a gera√ß√£o do PDF. Detalhe: ' + detalhe);
  }
}
</script>

</body>
</html>





