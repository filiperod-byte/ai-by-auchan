<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI by Auchan - App & Admin</title>
  <link rel="manifest" href="manifest.json">

  <script>
    // Cache-bust do config.js
    (function () {
      var versaoUnica = new Date().getTime();
      document.write('<script src="config.js?v=' + versaoUnica + '"><\/script>');
    })();
  </script>

  <style>
    /* --- ESTILOS GERAIS --- */
    body { margin: 0; font-family: "Roboto", Arial, sans-serif; background: linear-gradient(135deg, #d63a3e 0%, #6a1b9a 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #fff; }
    .app { width: min(420px, 95%); padding: 1rem; box-sizing: border-box; text-align: center; display: flex; flex-direction: column; min-height: 90vh; }
    .content-wrap { flex: 1; }
    .logo { width: 180px; margin: 0 auto 0.8rem auto; display: block; filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.25)); cursor: pointer; }
    .loja-info { font-size: .85rem; margin-bottom: 0.8rem; opacity: 0.9; }
    .change-store { font-size: .75rem; text-decoration: underline; cursor: pointer; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .btn { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: .5rem; display: flex; flex-direction: column; align-items: center; gap: .4rem; cursor: pointer; transition: transform .15s ease-in-out, box-shadow .15s; min-height: 160px; backdrop-filter: blur(8px); }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25); background: rgba(255, 255, 255, 0.18); }
    .btn img { width: 100%; max-width: 150px; object-fit: contain; border-radius: 14px; user-select: none; }
    .label { font-size: .9rem; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); }
    .app-footer { margin-top: 20px; font-size: 0.7rem; opacity: 0.8; font-family: sans-serif; display: flex; justify-content: center; gap: 15px; align-items: center; }
    .help-link { cursor: pointer; text-decoration: underline; font-weight: bold; color: #fff; }

    /* OVERLAYS */
    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 999; overflow-y: auto; }
    .overlay-box { position: relative; background: #ffffff; color: #333; border-radius: 18px; padding: 1.5rem 1.2rem; width: min(380px, 90%); box-shadow: 0 10px 25px rgba(0,0,0,.35); text-align: center; margin: 2rem 0; }
    .overlay-box h2 { margin-top: 0; margin-bottom: .8rem; font-size: 1.2rem; color: #d63a3e; }
    .overlay-box select, .overlay-box input, .overlay-box textarea { width: 100%; padding: .6rem; border-radius: 10px; border: 1px solid #ccc; font-size: .95rem; margin-bottom: 0.8rem; box-sizing: border-box; }
    .overlay-box textarea { resize: vertical; min-height: 80px; }
    .overlay-box button { width: 100%; padding: .6rem; border-radius: 999px; border: none; font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #d63a3e, #6a1b9a); color: #fff; cursor: pointer; margin-bottom: 0.5rem; }
    .overlay-box button.secondary { background: #eee; color: #333; }
    .overlay-box button.danger { background: #ff4444; color: white; }
    .overlay-box button.cancel { background: #777; color: white; }
    .file-btn { width: auto !important; padding: 0.6rem 1rem !important; background: #666 !important; white-space: nowrap; }

    /* Bot√£o de Fechar Overlay (X) */
    .close-overlay-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
    .close-overlay-btn:hover { color: #d63a3e; }

    /* ADMIN TABS */
    .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap; }
    .admin-tab { padding: 5px 10px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
    .admin-tab.active { border-bottom: 2px solid #d63a3e; color: #d63a3e; }
    .admin-list { text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px; font-size: 0.85rem; }
    .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .admin-item-text { flex-grow: 1; cursor: pointer; }
    .admin-item-text:hover { color: #d63a3e; font-weight: bold; }
    .admin-item button { width: auto; padding: 2px 8px; font-size: 0.7rem; margin: 0; border: 0; border-radius: 999px; cursor: pointer; }
    .admin-item button.delete { background: #ff4444; color: #fff; }
    .admin-item button.dup { background: #666; color: #fff; }

    .version-control { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: left; border: 1px solid #eee; }
    .version-control label { font-size: 0.8rem; color: #666; display: block; margin-bottom: 3px; }

    /* Tutorial */
    .tutorial-step { text-align: left; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .tutorial-icon { font-size: 1.5rem; line-height: 1; }
    .ios-share-icon { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
  </style>
</head>

<body>

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay" class="overlay">
    <div class="overlay-box" style="width: min(300px, 80%);">
      <span class="close-overlay-btn" onclick="fecharLogin()">‚úï</span>
      <h2>√Årea Reservada</h2>
      <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Insere a senha de administrador</p>
      <input type="password" id="login-password-input" placeholder="Senha" onkeyup="if(event.key === 'Enter') verificarSenhaLogin()">
      <button onclick="verificarSenhaLogin()">Entrar</button>
      <button class="secondary" onclick="fecharLogin()">Cancelar</button>
    </div>
  </div>

  <!-- LOJA OVERLAY -->
  <div id="loja-overlay" class="overlay">
    <div class="overlay-box">
      <span class="close-overlay-btn" onclick="fecharLojaOverlay()">‚úï</span>
      <h2>Escolhe formato e loja</h2>
      <select id="formato-select" onchange="atualizarSelectLojas()">
        <option value="" disabled selected>Seleciona o formato‚Ä¶</option>
      </select>
      <select id="loja-select" onchange="this.blur()">
        <option value="" disabled selected>Seleciona a loja‚Ä¶</option>
      </select>
      <button onclick="guardarLoja()">Guardar</button>
      <small>Podes mudar depois em ‚ÄúLoja: ‚Ä¶ (alterar)‚Äù</small>
    </div>
  </div>

  <!-- HELP OVERLAY -->
  <div id="help-overlay" class="overlay">
    <div class="overlay-box">
      <span class="close-overlay-btn" onclick="document.getElementById('help-overlay').style.display='none'">‚úï</span>
      <h2>üì≤ Instalar App</h2>

      <div id="help-ios">
        <p style="margin-bottom:15px; font-weight:bold; color:#666;">iPhone / iPad (iOS)</p>
        <div class="tutorial-step">
          <span class="tutorial-icon">1Ô∏è‚É£</span>
          <span>
            Toca no bot√£o de <b>Partilha</b> (quadrado com seta) na barra inferior do Safari.<br>
            <svg class="ios-share-icon" viewBox="0 0 50 50" style="width:24px; margin-top:5px;">
              <path d="M30.3 13.7L25 8.4l-5.3 5.3-1.4-1.4L25 5.6l6.7 6.7z"/>
              <path d="M24 7h2v21h-2z"/>
              <path d="M35 40H15c-1.7 0-3-1.3-3-3V19c0-1.7 1.3-3 3-3h7v2h-7c-0.6 0-1 0.4-1 1v18c0 0.6 0.4 1 1 1h20c0.6 0 1-0.4 1-1V19c0-0.6-0.4-1-1-1h-7v-2h7c1.7 0 3 1.3 3 3v18c0 1.7-1.3 3-3 3z"/>
            </svg>
          </span>
        </div>
        <div class="tutorial-step">
          <span class="tutorial-icon">2Ô∏è‚É£</span>
          <span>Rola para baixo e escolhe a op√ß√£o <b>"Adicionar ao Ecr√£ Principal"</b> (Add to Home Screen).</span>
        </div>
        <div class="tutorial-step">
          <span class="tutorial-icon">3Ô∏è‚É£</span>
          <span>Clica em <b>Adicionar</b> no topo direito.</span>
        </div>
      </div>

      <hr style="margin: 15px 0; opacity: 0.3;">

      <div id="help-android">
        <p style="margin-bottom:15px; font-weight:bold; color:#666;">Android (Chrome)</p>
        <div class="tutorial-step">
          <span>Toca nos 3 pontinhos (‚ãÆ) e escolhe <b>"Instalar Aplica√ß√£o"</b> ou "Adicionar ao Ecr√£ Principal".</span>
        </div>
      </div>

      <button class="secondary" onclick="document.getElementById('help-overlay').style.display='none'">Entendi</button>
    </div>
  </div>

  <!-- ADMIN OVERLAY -->
  <div id="admin-overlay" class="overlay">
    <div class="overlay-box" style="width: min(450px, 95%);">
      <h2>Painel de Administra√ß√£o</h2>
      <div class="admin-tabs" id="admin-tabs">
        <div class="admin-tab active" data-tab="lojas" onclick="switchAdminTab('lojas')">Lojas</div>
        <div class="admin-tab" data-tab="assistentes" onclick="switchAdminTab('assistentes')">Assistentes</div>
        <div class="admin-tab" data-tab="exportar" onclick="switchAdminTab('exportar')">Guardar</div>
        <!-- QRCodes √© criado por JS (inicializarAdminQRCodesTab) -->
      </div>

      <!-- TAB LOJAS -->
      <div id="admin-tab-lojas">
        <div class="admin-list" id="admin-lojas-list"></div>
        <h3>Adicionar Loja</h3>
        <select id="admin-novo-formato">
          <option value="Hiper">Hiper</option>
          <option value="Super">Super</option>
          <option value="Prox">Prox</option>
          <option value="Servicos">Servi√ßos</option>
        </select>
        <div style="display:flex; gap:5px;">
          <input type="text" id="admin-nova-loja-cod" placeholder="Cod" maxlength="3" style="width: 80px;">
          <input type="text" id="admin-nova-loja-nome" placeholder="Nome da Loja" style="flex:1;">
        </div>
        <button onclick="adminAddLoja()">Adicionar Loja</button>
      </div>

      <!-- TAB ASSISTENTES -->
      <div id="admin-tab-assistentes" style="display:none;">
        <div class="admin-list" id="admin-assistentes-list"></div>
        <h3 id="admin-ast-title">Adicionar Assistente</h3>
        <small style="display:block; margin-bottom:10px; color:#666;">Clica na lista acima para editar</small>

        <input type="text" id="admin-ast-label" placeholder="Nome no Bot√£o (Label)">
        <input type="text" id="admin-ast-url" placeholder="URL Destino">
        <textarea id="admin-ast-descricao" placeholder="Descri√ß√£o (obrigat√≥ria)"></textarea>

        <div style="display:flex; gap:5px; align-items:center;">
          <input type="text" id="admin-ast-icone" placeholder="Nome Imagem (ex: wally.jpg)" style="margin-bottom:0.8rem; flex:1;">
          <input type="file" id="admin-file-picker" style="display:none" onchange="selecionarImagemArquivo()">
          <button class="file-btn" onclick="document.getElementById('admin-file-picker').click()" style="margin-bottom:0.8rem;" title="Escolher ficheiro">üìÇ</button>
        </div>

        <div style="display:flex; gap:5px; margin-bottom: 0.8rem;">
          <select id="admin-ast-formato" style="margin-bottom:0;" onchange="atualizarSelectLojasAdmin()">
            <option value="">(Seleciona formato‚Ä¶)</option>
            <option value="*">Qualquer Formato (*)</option>
          </select>
          <select id="admin-ast-loja" style="margin-bottom:0;">
            <option value="">(Seleciona loja‚Ä¶)</option>
            <option value="*">Qualquer Loja (*)</option>
          </select>
        </div>

        <div style="display: flex; gap: 5px;">
          <button onclick="adminSaveAssistente()" id="btn-save-ast">Adicionar Assistente</button>
          <button onclick="cancelarEdicao()" id="btn-cancel-ast" class="cancel" style="display:none;">Cancelar</button>
        </div>
      </div>

      <!-- TAB EXPORTAR -->
      <div id="admin-tab-exportar" style="display:none;">
        <p style="font-size: 0.85rem; margin-bottom: 10px;">
          Gera e baixa o ficheiro <b>config.js</b>. Depois, faz upload apenas deste ficheiro para o GitHub.
        </p>

        <div class="version-control">
          <label>Vers√£o Atual:</label>
          <strong id="lbl-versao-atual" style="color:#333;">...</strong>
          <br><br>
          <label>Nova Vers√£o (sugest√£o):</label>
          <input type="text" id="input-nova-versao" style="width: 100%; margin-bottom:0;" placeholder="Ex: v1.1.1">
        </div>

        <button onclick="baixarConfiguracao()">üì• Download Ficheiro de Configura√ß√£o</button>
        <button class="danger" onclick="limparTudoAdmin()">‚ö†Ô∏è Reset de F√°brica</button>
      </div>

      <hr>
      <button class="secondary" onclick="fecharAdmin()">Fechar Admin</button>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="content-wrap">
      <img src="AibyAuchan.png" alt="AI by Auchan" class="logo" id="logo-trigger">
      <div class="loja-info">
        Loja: <span id="loja-nome">a definir‚Ä¶</span>
        <span class="change-store" onclick="forcarEscolhaLoja()">(alterar)</span>
      </div>
      <div class="grid"></div>
    </div>
    <div class="app-footer">
      <span class="help-link" onclick="document.getElementById('help-overlay').style.display='flex'">üì≤ Instalar App</span>
      <span id="app-footer-version" style="opacity:0.7">...</span>
    </div>
  </div>

  <script>
    /*************************************************
     *  CONFIG / CONSTANTES
     *************************************************/
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeGFYjlrXC27y-a8sXgdnxKD4XzT8yImmL_0CZRXP26NwjQhQ/formResponse';
    const ENTRY_LOJA = 'entry.1749648688';
    const ENTRY_ASSISTENTE = 'entry.182917282';

    const FORMATO_KEY = 'formatoSelecionado';
    const LOJA_KEY = 'lojaSelecionada';

    const ADMIN_QR_FORMATO_KEY = 'adminQrFormato';
    const ADMIN_QR_LOJA_KEY = 'adminQrLoja';

    const QR_PARAM_ASSISTENTE = 'assistente';
    const QR_PARAM_FORMATO = 'formato';
    const QR_PARAM_LOJA = 'loja';

    const ADMIN_PASSWORD = "9602";

    let STATE = { lojas: [], assistentes: [] };
    let editingAssistenteIndex = -1;

    const DADOS_PADRAO_FALLBACK = { lojas: [], assistentes: [] };

    /*************************************************
     *  INIT
     *************************************************/
    window.addEventListener('load', () => {
      carregarDados();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(console.log);
      }

      inicializarAdminQRCodesTab();
      processarQRCodeParams();
    });

    /*************************************************
     *  DADOS / STORAGE
     *************************************************/
    function carregarDados() {
      if (typeof DADOS_PADRAO === 'undefined' || typeof STORAGE_DATA_KEY === 'undefined') {
        console.warn("config.js n√£o encontrado. A usar fallback.");
        window.DADOS_PADRAO = DADOS_PADRAO_FALLBACK;
        window.STORAGE_DATA_KEY = "appConfigData_v0.0.0";
      }

      const dadosLocais = localStorage.getItem(STORAGE_DATA_KEY);
      STATE = dadosLocais ? JSON.parse(dadosLocais) : JSON.parse(JSON.stringify(DADOS_PADRAO));

      normalizarDescricoes();
      renderizarApp();
      atualizarVersaoRodape();
    }

    function guardarDadosLocais() {
      localStorage.setItem(STORAGE_DATA_KEY, JSON.stringify(STATE));
      renderizarApp();
    }

    function normalizarDescricoes() {
      if (!STATE || !Array.isArray(STATE.assistentes)) return;
      STATE.assistentes.forEach(a => {
        if (!a.descricao && a.desc) a.descricao = a.desc;
        if (!a.desc && a.descricao) a.desc = a.descricao; // compat
      });
    }

    function atualizarVersaoRodape() {
      let versao = "Desconhecida";
      if (typeof STORAGE_DATA_KEY !== 'undefined') {
        const parts = STORAGE_DATA_KEY.split('_v');
        versao = parts[1] ? `v${parts[1]}` : 'vX.X';
      }
      document.getElementById('app-footer-version').textContent = `Powered By G2G IAD3.0 ${String(versao).toUpperCase()}`;
    }

    /*************************************************
     *  HELPERS
     *************************************************/
    function formatarTextoBonito(t) {
      if (!t || t === "*") return t;
      return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
    }

    function ordenarLojas(a, b) {
      return (a.loja || '').localeCompare((b.loja || ''), undefined, { numeric: true, sensitivity: 'base' });
    }

    function obterFormatosUnicos() {
      const raw = (STATE.lojas || []).map(l => l.formato ? formatarTextoBonito(l.formato) : "");
      return [...new Set(raw)].filter(f => f !== "").sort();
    }

    function normKey_(s) {
      return (s || '').toString().trim().toLowerCase();
    }

    function normUpper_(s) {
      return (s || '').toString().trim().toUpperCase();
    }

    function isGlobalScope_(a) {
      return normUpper_(a.formato) === '*' && normUpper_(a.loja) === '*';
    }

    function scopesOverlap_(a, b) {
      const af = normUpper_(a.formato);
      const bf = normUpper_(b.formato);
      const al = normUpper_(a.loja);
      const bl = normUpper_(b.loja);

      // se algum est√° por definir, n√£o conflita
      if (!af || !bf || !al || !bl) return false;

      const fmtOverlap = (af === '*') || (bf === '*') || (af === bf);
      const lojaOverlap = (al === '*') || (bl === '*') || (al === bl);
      return fmtOverlap && lojaOverlap;
    }

    function gerarLabelCopiaUnica_(base) {
      let candidate = base;
      let n = 2;
      const exists = (lbl) => (STATE.assistentes || []).some(a => normKey_(a.label) === normKey_(lbl));
      while (exists(candidate)) {
        candidate = `${base} ${n}`;
        n++;
      }
      return candidate;
    }

    /*************************************************
     *  APP: SELE√á√ÉO DE LOJA + GRID
     *************************************************/
    function renderizarApp() {
      atualizarSelectFormato();
      atualizarUILoja();
    }

    function atualizarSelectFormato() {
      const s = document.getElementById('formato-select');
      const val = s.value;

      s.innerHTML = '<option value="" disabled selected>Seleciona o formato‚Ä¶</option>';
      obterFormatosUnicos().forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        s.appendChild(o);
      });

      if (val) s.value = val;
    }

    function atualizarSelectLojas() {
      const fmt = document.getElementById('formato-select').value;
      const s = document.getElementById('loja-select');

      s.innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      if (!fmt) return;

      const fmtN = fmt.toUpperCase();
      const ljs = (STATE.lojas || []).filter(l => (l.formato || '').toUpperCase() === fmtN);
      ljs.sort(ordenarLojas);

      ljs.forEach(l => {
        const o = document.createElement('option');
        o.value = l.loja;
        o.textContent = l.loja;
        s.appendChild(o);
      });
    }

    function atualizarUILoja() {
      const f = localStorage.getItem(FORMATO_KEY);
      const l = localStorage.getItem(LOJA_KEY);

      const span = document.getElementById('loja-nome');
      const over = document.getElementById('loja-overlay');

      if (f && l) {
        span.textContent = `${formatarTextoBonito(f)} ‚Äì ${l}`;
        over.style.display = 'none';
        renderizarGridAssistentes(f, l);
      } else {
        span.textContent = 'a definir‚Ä¶';
        over.style.display = 'flex';
        document.querySelector('.grid').innerHTML = '';
      }
    }

    function fecharLojaOverlay() {
      document.getElementById('loja-overlay').style.display = 'none';
    }

    function guardarLoja() {
      const f = document.getElementById('formato-select').value;
      const l = document.getElementById('loja-select').value;
      if (!f || !l) return alert('Escolhe formato e loja.');
      localStorage.setItem(FORMATO_KEY, f);
      localStorage.setItem(LOJA_KEY, l);
      atualizarUILoja();
    }

    function forcarEscolhaLoja() {
      document.getElementById('formato-select').value = "";
      document.getElementById('loja-select').innerHTML = '<option value="" disabled selected>Seleciona a loja‚Ä¶</option>';
      document.getElementById('loja-overlay').style.display = 'flex';
    }

    function filtrarAssistentesPorSelecao(uf, ul) {
      const ufN = (uf || '').toUpperCase();
      const ulN = (ul || '').toUpperCase();

      return (STATE.assistentes || []).filter(a => {
        const f = (a.formato || '').toUpperCase();
        const l = (a.loja || '').toUpperCase();
        return (f === '*' || f === ufN) && (l === '*' || l === ulN);
      });
    }

    function renderizarGridAssistentes(uf, ul) {
      const grid = document.querySelector('.grid');
      grid.innerHTML = '';

      const matches = filtrarAssistentesPorSelecao(uf, ul).slice().sort((a, b) => (a.label || '').localeCompare((b.label || '')));

      if (matches.length === 0) {
        grid.innerHTML = '<p style="grid-column: span 2; opacity: 0.7;">Nenhum assistente dispon√≠vel.</p>';
        return;
      }

      matches.forEach(a => {
        const btn = document.createElement('div');
        btn.className = 'btn';
        btn.onclick = () => abrirAssistente(a.nome || a.label, a.url);

        const img = document.createElement('img');
        img.src = a.icone || 'AibyAuchan.png';
        img.onerror = function () { this.src = 'AibyAuchan.png'; };

        const lbl = document.createElement('div');
        lbl.className = 'label';
        lbl.textContent = a.label || a.nome;

        btn.appendChild(img);
        btn.appendChild(lbl);
        grid.appendChild(btn);
      });
    }

    /*************************************************
     *  LOG + ABRIR ASSISTENTE
     *************************************************/
    function abrirAssistente(nomeAssistente, urlDestino) {
      const l = localStorage.getItem(LOJA_KEY) || 'Sem loja';
      const p = new URLSearchParams();
      p.append(ENTRY_LOJA, l);
      p.append(ENTRY_ASSISTENTE, nomeAssistente || 'Sem nome');

      fetch(FORM_BASE_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: p.toString()
      }).catch(() => {});

      window.open(urlDestino, '_blank');
    }

    /*************************************************
     *  QR PARAMS (SCAN)
     *************************************************/
    function processarQRCodeParams() {
      const params = new URLSearchParams(window.location.search);
      if (!params.has(QR_PARAM_ASSISTENTE)) return;

      const assistenteParam = params.get(QR_PARAM_ASSISTENTE);
      const formatoParam = params.get(QR_PARAM_FORMATO);
      const lojaParam = params.get(QR_PARAM_LOJA);

      if (formatoParam) localStorage.setItem(FORMATO_KEY, formatoParam);
      if (lojaParam) localStorage.setItem(LOJA_KEY, lojaParam);

      const assistente = (STATE.assistentes || []).find(a => a.nome === assistenteParam || a.label === assistenteParam);
      if (!assistente) {
        alert("Assistente n√£o encontrado.");
        return;
      }

      const lojaFinal = lojaParam || localStorage.getItem(LOJA_KEY) || 'Sem loja';
      const payload = new URLSearchParams();
      payload.append(ENTRY_LOJA, lojaFinal);
      payload.append(ENTRY_ASSISTENTE, assistente.nome || assistente.label || assistenteParam);

      const body = payload.toString();

      if (navigator.sendBeacon) {
        navigator.sendBeacon(FORM_BASE_URL, new Blob([body], { type: 'application/x-www-form-urlencoded' }));
        window.location.replace(assistente.url);
        return;
      }

      fetch(FORM_BASE_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body,
        keepalive: true
      }).finally(() => window.location.replace(assistente.url));
    }

    /*************************************************
     *  ADMIN: ABRIR COM 5 CLICKS NO LOGO
     *************************************************/
    (function bindAdminTrigger_() {
      let lc = 0;
      document.getElementById('logo-trigger').addEventListener('click', () => {
        lc++;
        if (lc === 5) {
          lc = 0;
          abrirLogin();
        }
      });
    })();

    function abrirLogin() {
      document.getElementById('login-overlay').style.display = 'flex';
      setTimeout(() => document.getElementById('login-password-input').focus(), 100);
    }

    function fecharLogin() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('login-password-input').value = '';
    }

    function verificarSenhaLogin() {
      if (document.getElementById('login-password-input').value === ADMIN_PASSWORD) {
        fecharLogin();
        abrirAdmin();
      } else {
        alert("Senha incorreta.");
      }
    }

    function abrirAdmin() {
      document.getElementById('admin-overlay').style.display = 'flex';
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();
      // se estivermos em QRCodes, garante lista atualizada
      const tabQr = document.getElementById('admin-tab-qrcodes');
      if (tabQr && tabQr.style.display === 'block') renderizarListaQRCodes_();
    }

    function fecharAdmin() {
      document.getElementById('admin-overlay').style.display = 'none';
      cancelarEdicao();
    }

    function switchAdminTab(tabId) {
      // tabs active class
      document.querySelectorAll('#admin-tabs .admin-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tabId);
      });

      // hide all
      ['lojas','assistentes','exportar','qrcodes'].forEach(id => {
        const el = document.getElementById(`admin-tab-${id}`);
        if (el) el.style.display = 'none';
      });

      // show current
      const cur = document.getElementById(`admin-tab-${tabId}`);
      if (cur) cur.style.display = 'block';

      // side effects
      if (tabId === 'assistentes') atualizarDropdownsAdminInicial();
      if (tabId === 'exportar') atualizarSugestaoVersao();
      if (tabId === 'qrcodes') {
        popularDropdownsAdminQr_();
        renderizarListaQRCodes_();
      }
    }

    /*************************************************
     *  ADMIN: LISTAS (LOJAS + ASSISTENTES)
     *************************************************/
    function renderizarAdminListas() {
      // LOJAS
      const ll = document.getElementById('admin-lojas-list');
      ll.innerHTML = '';
      const lSorted = (STATE.lojas || []).slice().sort(ordenarLojas);

      lSorted.forEach(l => {
        const idx = STATE.lojas.indexOf(l);
        const d = document.createElement('div');
        d.className = 'admin-item';
        d.innerHTML = `
          <span>${formatarTextoBonito(l.formato)} - ${l.loja}</span>
          <button type="button" class="delete" onclick="adminRemoverLoja(${idx})" title="Apagar">X</button>
        `;
        ll.appendChild(d);
      });

      // ASSISTENTES
      const al = document.getElementById('admin-assistentes-list');
      al.innerHTML = '';
      const aSorted = (STATE.assistentes || []).slice().sort((a, b) => (a.label || '').localeCompare((b.label || '')));

      aSorted.forEach(a => {
        const idx = STATE.assistentes.indexOf(a);
        const d = document.createElement('div');
        d.className = 'admin-item';
        d.innerHTML = `
          <div class="admin-item-text" onclick="prepararEdicao(${idx})">
            ${(a.label || a.nome || '(sem nome)')}
            <small style="opacity:0.7">(${a.formato || '‚Äî'})(${a.loja || '‚Äî'})</small>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="dup" onclick="adminDuplicarAssistenteByIndex(${idx})" title="Duplicar">‚ßâ</button>
            <button type="button" class="delete" onclick="adminRemoverAssistenteByIndex(${idx})" title="Apagar">X</button>
          </div>
        `;
        al.appendChild(d);
      });
    }

    function selecionarImagemArquivo() {
      const i = document.getElementById('admin-file-picker');
      if (i.files && i.files[0]) document.getElementById('admin-ast-icone').value = i.files[0].name;
    }

    function adminAddLoja() {
      let f = document.getElementById('admin-novo-formato').value;
      const c = document.getElementById('admin-nova-loja-cod').value.trim();
      const n = document.getElementById('admin-nova-loja-nome').value.trim();
      if (!c || !n) return alert("Preenche c√≥digo e nome.");

      f = formatarTextoBonito(f);
      const lc = `${c}-${n}`;

      if ((STATE.lojas || []).some(l => l.formato === f && l.loja === lc)) return alert("Loja j√° existe.");

      STATE.lojas.push({ formato: f, loja: lc });
      guardarDadosLocais();
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();

      document.getElementById('admin-nova-loja-cod').value = '';
      document.getElementById('admin-nova-loja-nome').value = '';
    }

    function adminRemoverLoja(i) {
      if (!confirm("Apagar?")) return;
      STATE.lojas.splice(i, 1);
      guardarDadosLocais();
      renderizarAdminListas();
      atualizarDropdownsAdminInicial();
    }

    function adminRemoverAssistenteByIndex(i) {
      if (!Number.isInteger(i) || !STATE.assistentes[i]) return;
      if (!confirm("Apagar?")) return;

      STATE.assistentes.splice(i, 1);
      guardarDadosLocais();
      renderizarAdminListas();

      if (editingAssistenteIndex === i) cancelarEdicao();

      // se estiver no QRCodes, refresca
      const tabQr = document.getElementById('admin-tab-qrcodes');
      if (tabQr && tabQr.style.display === 'block') renderizarListaQRCodes_();
    }

    function adminDuplicarAssistenteByIndex(i) {
      const src = STATE.assistentes[i];
      if (!src) return;

      const baseLabel = (src.label || src.nome || 'Assistente') + ' (c√≥pia)';
      const clone = {
        ...src,
        nome: src.nome || src.label || (src.label || 'Assistente'),
        label: gerarLabelCopiaUnica_(baseLabel),
        // obriga o user a escolher scope (para n√£o ‚Äúaparecer‚Äù sem querer)
        formato: '',
        loja: ''
      };

      STATE.assistentes.push(clone);
      guardarDadosLocais();
      renderizarAdminListas();
      prepararEdicao(STATE.assistentes.length - 1);
    }

    /*************************************************
     *  ADMIN: DROPDOWNS (ASSISTENTES)
     *************************************************/
    function atualizarDropdownsAdminInicial() {
      const s = document.getElementById('admin-ast-formato');
      const prev = s.value;

      s.innerHTML = `
        <option value="">(Seleciona formato‚Ä¶)</option>
        <option value="*">Qualquer Formato (*)</option>
      `;

      obterFormatosUnicos().forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        s.appendChild(o);
      });

      if (prev !== undefined && prev !== null) s.value = prev;
      atualizarSelectLojasAdmin();
    }

    function atualizarSelectLojasAdmin() {
      const sf = document.getElementById('admin-ast-formato');
      const sl = document.getElementById('admin-ast-loja');
      const prev = sl.value;

      sl.innerHTML = `
        <option value="">(Seleciona loja‚Ä¶)</option>
        <option value="*">Qualquer Loja (*)</option>
      `;

      let list = [];
      if (sf.value === '*') list = (STATE.lojas || []).slice();
      else if (sf.value === '') list = [];
      else list = (STATE.lojas || []).filter(l => (l.formato || '').toUpperCase() === sf.value.toUpperCase());

      list.sort(ordenarLojas);
      list.forEach(l => {
        const o = document.createElement('option');
        o.value = l.loja;
        o.textContent = l.loja;
        sl.appendChild(o);
      });

      if (Array.from(sl.options).some(o => o.value === prev)) sl.value = prev;
    }

    /*************************************************
     *  ADMIN: EDITAR / GUARDAR ASSISTENTE
     *************************************************/
    function prepararEdicao(i) {
      editingAssistenteIndex = i;
      const a = STATE.assistentes[i];

      document.getElementById('admin-ast-label').value = (a.label || '');
      document.getElementById('admin-ast-url').value = (a.url || '');
      document.getElementById('admin-ast-icone').value = (a.icone || '');
      document.getElementById('admin-ast-descricao').value = (a.descricao || a.desc || '');

      atualizarDropdownsAdminInicial();
      document.getElementById('admin-ast-formato').value = a.formato ? formatarTextoBonito(a.formato) : '';
      atualizarSelectLojasAdmin();
      document.getElementById('admin-ast-loja').value = a.loja || '';

      document.getElementById('admin-ast-title').innerText = "Editar Assistente";
      document.getElementById('btn-save-ast').innerText = "Atualizar";
      document.getElementById('btn-cancel-ast').style.display = "block";
    }

    function cancelarEdicao() {
      editingAssistenteIndex = -1;
      ['admin-ast-label','admin-ast-url','admin-ast-icone','admin-ast-descricao'].forEach(id => {
        document.getElementById(id).value = '';
      });

      atualizarDropdownsAdminInicial();
      document.getElementById('admin-ast-formato').value = '';
      atualizarSelectLojasAdmin();
      document.getElementById('admin-ast-loja').value = '';

      document.getElementById('admin-ast-title').innerText = "Adicionar Assistente";
      document.getElementById('btn-save-ast').innerText = "Adicionar Assistente";
      document.getElementById('btn-cancel-ast').style.display = "none";
    }

    function validarConflitosAssistente_(novo, editingIdx) {
      const novoKey = normKey_(novo.label || novo.nome);
      if (!novoKey) return null;

      for (let idx = 0; idx < (STATE.assistentes || []).length; idx++) {
        if (idx === editingIdx) continue;
        const a = STATE.assistentes[idx];

        const aKey = normKey_(a.label || a.nome);
        if (aKey !== novoKey) continue;

        if (!scopesOverlap_(a, novo)) continue;

        const aGlobal = isGlobalScope_(a);
        const novoGlobal = isGlobalScope_(novo);

        if (aGlobal && !novoGlobal) {
          return `J√° existe um assistente GERAL (*)(*) com este nome. N√£o podes criar um mais espec√≠fico com o mesmo nome.`;
        }
        if (!aGlobal && novoGlobal) {
          return `J√° existem assistentes espec√≠ficos com este nome. N√£o podes criar um assistente GERAL (*)(*) com o mesmo nome.`;
        }

        return `Conflito: j√° existe um assistente com o mesmo nome cujo escopo se sobrep√µe a este.`;
      }
      return null;
    }

    function adminSaveAssistente() {
      const l = document.getElementById('admin-ast-label').value.trim();
      const u = document.getElementById('admin-ast-url').value.trim();
      const i = document.getElementById('admin-ast-icone').value.trim();
      const d = document.getElementById('admin-ast-descricao').value.trim();

      let f = (document.getElementById('admin-ast-formato').value || '').trim();
      let loj = (document.getElementById('admin-ast-loja').value || '').trim();

      if (!l || !u) return alert("Falta Nome ou URL");
      if (!d) return alert("A descri√ß√£o √© obrigat√≥ria (para o PDF n√£o dar rage üòÖ).");

      // obriga a escolher formato e loja (pode ser "*")
      if (!f || !loj) {
        alert('Escolhe Formato e Loja (podes usar "*" se for geral).');
        return;
      }

      if (f !== '*') f = formatarTextoBonito(f);

      const novo = {
        formato: f,
        loja: loj,
        nome: l,      // nome = label (como tinhas)
        label: l,
        url: u,
        icone: i,
        descricao: d,
        desc: d
      };

      const conflito = validarConflitosAssistente_(novo, editingAssistenteIndex);
      if (conflito) return alert(conflito);

      // bloqueia duplicado exacto
      const dupExato = (STATE.assistentes || []).some((a, idx) => {
        if (idx === editingAssistenteIndex) return false;
        return (
          normKey_(a.label) === normKey_(novo.label) &&
          normKey_(a.url) === normKey_(novo.url) &&
          normUpper_(a.formato) === normUpper_(novo.formato) &&
          normUpper_(a.loja) === normUpper_(novo.loja)
        );
      });
      if (dupExato) return alert("Assistente duplicado!");

      if (editingAssistenteIndex >= 0) STATE.assistentes[editingAssistenteIndex] = novo;
      else STATE.assistentes.push(novo);

      guardarDadosLocais();
      renderizarAdminListas();
      cancelarEdicao();

      const tabQr = document.getElementById('admin-tab-qrcodes');
      if (tabQr && tabQr.style.display === 'block') renderizarListaQRCodes_();
    }

    /*************************************************
     *  EXPORTAR CONFIG.JS
     *************************************************/
    function atualizarSugestaoVersao() {
      let v = "1.0.0";
      if (typeof STORAGE_DATA_KEY !== 'undefined') {
        const parts = STORAGE_DATA_KEY.split('_v');
        v = parts[1] || "1.0.0";
      }

      document.getElementById('lbl-versao-atual').textContent = "v" + v;

      let p = v.split('.').map(Number);
      while (p.length < 3) p.push(0);
      p[p.length - 1]++;

      document.getElementById('input-nova-versao').value = "v" + p.join('.');
    }

    function baixarConfiguracao() {
      let vUser = document.getElementById('input-nova-versao').value.trim();
      if (vUser.startsWith('v')) vUser = vUser.substring(1);
      const newKey = "appConfigData_v" + vUser;

      // normaliza formatos
      (STATE.lojas || []).forEach(l => { if (l.formato) l.formato = formatarTextoBonito(l.formato); });
      (STATE.assistentes || []).forEach(a => { if (a.formato && a.formato !== '*') a.formato = formatarTextoBonito(a.formato); });

      // ordenar
      STATE.lojas.sort(ordenarLojas);

      // garantir "descricao" sempre
      (STATE.assistentes || []).forEach(a => {
        const desc = (a.descricao || a.desc || '').trim();
        a.descricao = desc;
        a.desc = desc;
      });

      STATE.assistentes.sort((a, b) => (a.label || '').localeCompare((b.label || '')));

      let content = `// Ficheiro de Configura√ß√£o Gerado Automaticamente\n`;
      content += `const STORAGE_DATA_KEY = "${newKey}";\n\n`;
      content += `const DADOS_PADRAO = {\n`;
      content += `  lojas: [\n`;
      (STATE.lojas || []).forEach((l, idx) => {
        let line = JSON.stringify(l);
        if (idx < STATE.lojas.length - 1) line += ",";
        content += `    ${line}\n`;
      });
      content += `  ],\n`;
      content += `  assistentes: [\n`;
      (STATE.assistentes || []).forEach((a, idx) => {
        let block = JSON.stringify(a, null, 4);
        block = block.split('\n').map(line => "    " + line).join('\n');
        if (idx < STATE.assistentes.length - 1) block += ",";
        content += `${block}\n`;
      });
      content += `  ]\n`;
      content += `};\n`;

      const blob = new Blob([content], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "config.js";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert("config.js baixado! Faz upload dele para o GitHub üòé");
    }

    function limparTudoAdmin() {
      if (!confirm("Resetar F√°brica?")) return;
      localStorage.removeItem(STORAGE_DATA_KEY);
      location.reload();
    }

    /*************************************************
     *  QRCODES: CONTEXTO (ADMIN OU APP)
     *************************************************/
    function getQrContext_() {
      const af = (localStorage.getItem(ADMIN_QR_FORMATO_KEY) || '').trim();
      const al = (localStorage.getItem(ADMIN_QR_LOJA_KEY) || '').trim();
      if (af && al) return { formato: af, loja: al, source: 'admin' };

      const f = (localStorage.getItem(FORMATO_KEY) || '').trim();
      const l = (localStorage.getItem(LOJA_KEY) || '').trim();
      return { formato: f, loja: l, source: 'app' };
    }

    function setQrContextAdmin_(formato, loja) {
      localStorage.setItem(ADMIN_QR_FORMATO_KEY, formato || '');
      localStorage.setItem(ADMIN_QR_LOJA_KEY, loja || '');
    }

    function clearQrContextAdmin_() {
      localStorage.removeItem(ADMIN_QR_FORMATO_KEY);
      localStorage.removeItem(ADMIN_QR_LOJA_KEY);
    }

    function getLojasPorFormato_(formato) {
      const f = (formato || '').trim();
      if (!f) return [];
      if (f === '*') return (STATE.lojas || []).slice().sort(ordenarLojas);
      return (STATE.lojas || []).filter(x => normUpper_(x.formato) === normUpper_(f)).sort(ordenarLojas);
    }

    /*************************************************
     *  QRCODES: UI TAB
     *************************************************/
    function inicializarAdminQRCodesTab() {
      const tabsContainer = document.getElementById('admin-tabs');
      if (!tabsContainer || document.getElementById('admin-tab-qrcodes')) return;

      const tab = document.createElement('div');
      tab.className = 'admin-tab';
      tab.dataset.tab = 'qrcodes';
      tab.textContent = 'QRCodes';
      tab.onclick = () => switchAdminTab('qrcodes');
      tabsContainer.appendChild(tab);

      const overlayBox = document.querySelector('#admin-overlay .overlay-box');
      const exportarTab = document.getElementById('admin-tab-exportar');

      const qrcodesTab = document.createElement('div');
      qrcodesTab.id = 'admin-tab-qrcodes';
      qrcodesTab.style.display = 'none';

      qrcodesTab.innerHTML = `
        <p style="font-size:0.85rem; margin-bottom:10px;">
          Aqui escolhes Formato/Loja no Admin e imprimes o que for preciso, sem sair do painel.
        </p>

        <div class="version-control" style="margin-bottom:10px;">
          <label>Sele√ß√£o para impress√£o (Admin):</label>

          <div style="display:flex; gap:8px; margin-bottom:10px;">
            <select id="admin-qr-formato" style="margin-bottom:0;" onchange="onAdminQrFormatoChange_()">
              <option value="">(usar sele√ß√£o da App)</option>
              <option value="*">Qualquer Formato (*)</option>
            </select>

            <select id="admin-qr-loja" style="margin-bottom:0;" onchange="onAdminQrLojaChange_()">
              <option value="">(usar sele√ß√£o da App)</option>
              <option value="*">Qualquer Loja (*)</option>
            </select>
          </div>

          <div style="display:flex; gap:8px; margin-bottom:10px;">
            <button class="secondary" style="flex:1; padding:.55rem;" onclick="usarSelecaoAppNoQr_()">Usar sele√ß√£o da App</button>
            <button class="secondary" style="flex:1; padding:.55rem;" onclick="renderizarListaQRCodes_()">Atualizar lista</button>
          </div>

          <label>Sele√ß√£o atual:</label>
          <strong id="admin-qrcodes-selecao" style="color:#333;">...</strong>

          <div id="admin-qrcodes-warning" style="margin-top:8px; font-size:0.85rem;"></div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
            <label style="display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;">
              <input type="checkbox" id="admin-qrcodes-selectall" />
              <span style="font-weight:800; color:#333;">Selecionar tudo</span>
            </label>
            <span id="admin-qrcodes-count" style="font-size:0.85rem; color:#666;">...</span>
          </div>

          <div id="admin-qrcodes-list"
               style="margin-top:10px; max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:12px; background:#fafafa;">
          </div>
        </div>

        <button onclick="gerarPDFQRCodes()">üìÑ Gerar PDF QRCodes</button>
      `;

      overlayBox.insertBefore(qrcodesTab, exportarTab.nextSibling);
    }

    function popularDropdownsAdminQr_() {
      const sf = document.getElementById('admin-qr-formato');
      const sl = document.getElementById('admin-qr-loja');
      if (!sf || !sl) return;

      // formats: mant√©m as 2 base options e reinjeta √∫nicos
      const keep = sf.innerHTML;
      sf.innerHTML = keep;

      obterFormatosUnicos().forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = f;
        sf.appendChild(o);
      });

      // re-aplica sele√ß√£o guardada (se existir)
      const af = localStorage.getItem(ADMIN_QR_FORMATO_KEY) || '';
      const al = localStorage.getItem(ADMIN_QR_LOJA_KEY) || '';

      if (sf.value !== af) sf.value = af;
      rebuildAdminQrLojas_();

      if (al && Array.from(sl.options).some(o => o.value === al)) sl.value = al;
    }

    function rebuildAdminQrLojas_() {
      const sf = document.getElementById('admin-qr-formato');
      const sl = document.getElementById('admin-qr-loja');
      if (!sf || !sl) return;

      const f = (sf.value || '').trim();
      const prev = (sl.value || '').trim();

      sl.innerHTML = `
        <option value="">(usar sele√ß√£o da App)</option>
        <option value="*">Qualquer Loja (*)</option>
      `;

      if (f) {
        const lojas = getLojasPorFormato_(f);
        lojas.forEach(l => {
          const o = document.createElement('option');
          o.value = l.loja;
          o.textContent = l.loja;
          sl.appendChild(o);
        });
      }

      if (prev && Array.from(sl.options).some(o => o.value === prev)) sl.value = prev;
    }

    function onAdminQrFormatoChange_() {
      rebuildAdminQrLojas_();

      const sf = document.getElementById('admin-qr-formato');
      const sl = document.getElementById('admin-qr-loja');
      if (!sf || !sl) return;

      const f = (sf.value || '').trim();
      const l = (sl.value || '').trim();

      if (f && l) setQrContextAdmin_(f, l);
      else clearQrContextAdmin_();

      renderizarListaQRCodes_();
    }

    function onAdminQrLojaChange_() {
      const sf = document.getElementById('admin-qr-formato');
      const sl = document.getElementById('admin-qr-loja');
      if (!sf || !sl) return;

      const f = (sf.value || '').trim();
      const l = (sl.value || '').trim();

      if (f && l) setQrContextAdmin_(f, l);
      else clearQrContextAdmin_();

      renderizarListaQRCodes_();
    }

    function usarSelecaoAppNoQr_() {
      clearQrContextAdmin_();
      const sf = document.getElementById('admin-qr-formato');
      const sl = document.getElementById('admin-qr-loja');
      if (sf) sf.value = '';
      if (sl) sl.value = '';
      renderizarListaQRCodes_();
    }

    /*************************************************
     *  QRCODES: PUBLICADO vs LOCAL (por URL)
     *************************************************/
    function normalizarUrl_(u) {
      return (u || '').toString().trim();
    }

    function normalizarDesc_(d) {
      return (d || '').toString().trim();
    }

    function mapUrlParaDescricao_(arr) {
      const m = new Map();
      (arr || []).forEach(a => {
        const url = normalizarUrl_(a.url);
        const desc = normalizarDesc_(a.descricao || a.desc);
        if (!url) return;
        if (!m.has(url)) m.set(url, desc || '');
        if (m.get(url) === '' && desc) m.set(url, desc);
      });
      return m;
    }

    function buildPublishedDescMap_() {
      const publicados = (typeof DADOS_PADRAO !== 'undefined' && DADOS_PADRAO && Array.isArray(DADOS_PADRAO.assistentes))
        ? DADOS_PADRAO.assistentes
        : [];
      return mapUrlParaDescricao_(publicados);
    }

    function contarAlteracoesDescricaoNaoPublicadas_(assistentesFiltrados) {
      const pubMap = buildPublishedDescMap_();
      const localMap = mapUrlParaDescricao_(assistentesFiltrados);

      let count = 0;
      localMap.forEach((descLocal, url) => {
        const descPub = pubMap.has(url) ? (pubMap.get(url) || '') : null;
        if (descPub === null) { count++; return; }
        if (normalizarDesc_(descPub) !== normalizarDesc_(descLocal)) count++;
      });

      return { count };
    }

    function getAssistenteChangeTag_(a, pubMap) {
      const url = normalizarUrl_(a.url);
      if (!url) return { tipo: '', changed: false };

      const localDesc = normalizarDesc_(a.descricao || a.desc);
      const pubDesc = pubMap.has(url) ? normalizarDesc_(pubMap.get(url) || '') : null;

      if (pubDesc === null) return { tipo: 'novo', changed: true };
      if (pubDesc !== localDesc) return { tipo: 'alterado', changed: true };
      return { tipo: '', changed: false };
    }

    /*************************************************
     *  QRCODES: LISTA + HIGHLIGHT
     *************************************************/
    function renderizarListaQRCodes_() {
      const selecao = document.getElementById('admin-qrcodes-selecao');
      const warning = document.getElementById('admin-qrcodes-warning');
      const list = document.getElementById('admin-qrcodes-list');
      const selectAll = document.getElementById('admin-qrcodes-selectall');
      const count = document.getElementById('admin-qrcodes-count');

      if (!selecao || !warning || !list || !selectAll || !count) return;

      const ctx = getQrContext_();
      const formato = ctx.formato;
      const loja = ctx.loja;

      if (!formato || !loja) {
        selecao.textContent = 'Sem sele√ß√£o';
        warning.innerHTML = `<span style="color:#d63a3e; font-weight:900;">
          Escolhe Formato e Loja (Admin) ou define na App.
        </span>`;
        list.innerHTML = '';
        count.textContent = '';
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = true;
        return;
      }

      selecao.textContent = `${formatarTextoBonito(formato)} ‚Äì ${loja} ${ctx.source === 'admin' ? '(Admin)' : '(App)'}`;

      const ufN = normUpper_(formato);
      const ulN = normUpper_(loja);

      // ‚ö†Ô∏è aqui "sele√ß√£o *" significa wildcard total (mostrar tudo)
      const candidatos = (STATE.assistentes || [])
        .map((a, idx) => ({ ...a, __index: idx }))
        .filter(a => {
          const f = normUpper_(a.formato);
          const l = normUpper_(a.loja);

          const fmtMatch = (ufN === '*') ? true : (f === '*' || f === ufN);
          const lojaMatch = (ulN === '*') ? true : (l === '*' || l === ulN);

          return fmtMatch && lojaMatch;
        })
        .sort((a, b) => (a.label || '').localeCompare((b.label || '')));

      const changesInfo = contarAlteracoesDescricaoNaoPublicadas_(candidatos);
      warning.innerHTML = (changesInfo.count > 0)
        ? `<span style="color:#d63a3e; font-weight:900;">
            ‚ö†Ô∏è Existem ${changesInfo.count} descri√ß√µes novas/alteradas face ao publicado.
            Depois imprime e vai √† aba <b>Guardar</b> fazer download do <b>config.js</b>.
          </span>`
        : `<span style="color:#2e7d32; font-weight:900;">‚úÖ Tudo sincronizado com a vers√£o publicada.</span>`;

      count.textContent = `${candidatos.length} assistente(s)`;

      if (candidatos.length === 0) {
        list.innerHTML = `<div style="padding:12px; color:#666;">Nenhum assistente dispon√≠vel para esta sele√ß√£o.</div>`;
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = true;
        return;
      }

      selectAll.disabled = false;

      const pubMap = buildPublishedDescMap_();

      list.innerHTML = candidatos.map(a => {
        const img = (a.icone || 'AibyAuchan.png');
        const label = (a.label || a.nome || '').trim();
        const scope = `${(a.formato ? formatarTextoBonito(a.formato) : '‚Äî')} ¬∑ ${(a.loja || '‚Äî')}`;

        const tag = getAssistenteChangeTag_(a, pubMap);

        const bg = tag.tipo === 'novo'
          ? 'background:#e8f5e9;'
          : tag.tipo === 'alterado'
            ? 'background:#fff3e0;'
            : 'background:#fff;';

        const badge = tag.tipo === 'novo'
          ? `<span style="font-size:.75rem; font-weight:900; color:#2e7d32;">üÜï Novo</span>`
          : tag.tipo === 'alterado'
            ? `<span style="font-size:.75rem; font-weight:900; color:#ef6c00;">‚ö†Ô∏è Alterado</span>`
            : '';

        return `
          <label style="
            display:flex; align-items:center; gap:12px;
            padding:10px 12px; border-bottom:1px solid #eee;
            cursor:pointer; user-select:none; ${bg}
          ">
            <img src="${img}" onerror="this.src='AibyAuchan.png'"
                 style="width:38px; height:38px; object-fit:cover; border-radius:10px; border:1px solid #eee; flex:0 0 auto;" />

            <div style="flex:1; min-width:0;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="font-weight:900; color:#333; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${label}
                </div>
                ${badge}
              </div>

              <div style="font-size:0.8rem; color:#666; line-height:1.2;">
                ${scope}
              </div>
            </div>

            <input type="checkbox" class="qr-ast-check" data-idx="${a.__index}" checked
                   style="width:18px; height:18px; flex:0 0 auto;" />
          </label>
        `;
      }).join('');

      // select all behaviour
      selectAll.checked = true;
      selectAll.indeterminate = false;

      selectAll.onchange = () => {
        const cbs = list.querySelectorAll('input.qr-ast-check');
        cbs.forEach(cb => cb.checked = selectAll.checked);
        selectAll.indeterminate = false;
      };

      if (!list.dataset.boundChange) {
        list.dataset.boundChange = '1';
        list.addEventListener('change', () => {
          const cbs = [...list.querySelectorAll('input.qr-ast-check')];
          const allOn = cbs.length > 0 && cbs.every(cb => cb.checked);
          const anyOn = cbs.some(cb => cb.checked);
          selectAll.indeterminate = anyOn && !allOn;
          selectAll.checked = allOn;
        }, { passive: true });
      }
    }

    /*************************************************
     *  PDF: libs + QR + imagens
     *************************************************/
    function carregarScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Falha ao carregar biblioteca: ' + src));
        document.head.appendChild(s);
      });
    }

    async function garantirPdfLib() {
      if (window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
      await carregarScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
      return window.jspdf.jsPDF;
    }

    function criarUrlQRCode(assistente, formato, loja) {
      const base = `${window.location.origin}${window.location.pathname}`;
      const params = new URLSearchParams();

      params.set(QR_PARAM_ASSISTENTE, assistente.nome || assistente.label || '');

      // evita gravar '*' na app de quem scaneia
      if (formato && formato !== '*') params.set(QR_PARAM_FORMATO, formato);
      if (loja && loja !== '*') params.set(QR_PARAM_LOJA, loja);

      return `${base}?${params.toString()}`;
    }

    async function carregarImagemComoDataURL(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = src;
      });
    }

    async function gerarQRCodeDataURL(texto) {
      const api = `https://api.qrserver.com/v1/create-qr-code/?size=700x700&data=${encodeURIComponent(texto)}`;
      const res = await fetch(api);
      if (!res.ok) throw new Error(`QR API HTTP ${res.status}`);

      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    /*************************************************
     *  MODAL: DESCRI√á√ïES EM FALTA (para PDF)
     *************************************************/
    function garantirModalDescricao() {
      if (document.getElementById('missing-desc-overlay')) return;

      const overlay = document.createElement('div');
      overlay.id = 'missing-desc-overlay';
      overlay.className = 'overlay';
      overlay.innerHTML = `
        <div class="overlay-box" style="width:min(520px,95%); text-align:left;">
          <span class="close-overlay-btn" onclick="document.getElementById('missing-desc-overlay').style.display='none'">‚úï</span>
          <h2>Faltam descri√ß√µes üòÖ</h2>
          <p style="margin-top:0; font-size:.9rem; color:#666;">
            Preenche as descri√ß√µes em falta. Sem isso, n√£o d√° para gerar o PDF.
          </p>
          <div id="missing-desc-list" style="max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa;"></div>
          <div style="display:flex; gap:10px; margin-top:12px;">
            <button onclick="window.__missingDescSaveAndContinue()">Guardar e Continuar</button>
            <button class="secondary" onclick="document.getElementById('missing-desc-overlay').style.display='none'">Cancelar</button>
          </div>
          <div id="missing-desc-error" style="margin-top:10px; font-size:.85rem; color:#d63a3e; font-weight:600;"></div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function abrirModalDescricaoEmFalta(lista, onDone) {
      garantirModalDescricao();

      const overlay = document.getElementById('missing-desc-overlay');
      const list = document.getElementById('missing-desc-list');
      const err = document.getElementById('missing-desc-error');

      err.textContent = '';
      list.innerHTML = lista.map(a => `
        <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #eee;">
          <div style="font-weight:700; color:#333; margin-bottom:6px;">
            ${a.label || a.nome}
          </div>
          <textarea
            data-missing-desc="1"
            data-ast-index="${a.__index}"
            placeholder="Descri√ß√£o (2-3 linhas)"
            style="width:100%; box-sizing:border-box; padding:.6rem; border-radius:10px; border:1px solid #ccc; min-height:72px; resize:vertical;"
          >${(a.descricao || a.desc || '').trim()}</textarea>
        </div>
      `).join('');

      window.__missingDescSaveAndContinue = function () {
        err.textContent = '';

        const tas = [...list.querySelectorAll('textarea[data-missing-desc="1"]')];
        const faltam = tas.some(ta => !(ta.value || '').trim());
        if (faltam) {
          err.textContent = 'Ainda faltam descri√ß√µes. Preenche tudo para continuar.';
          return;
        }

        tas.forEach(ta => {
          const idx = Number(ta.getAttribute('data-ast-index'));
          const val = (ta.value || '').trim();
          if (Number.isNaN(idx) || !STATE.assistentes[idx]) return;

          const ref = STATE.assistentes[idx];
          const refUrl = normalizarUrl_(ref.url);

          // atualiza o atual
          ref.descricao = val;
          ref.desc = val;

          // propaga por URL (mesmo assistente)
          if (refUrl) {
            (STATE.assistentes || []).forEach(a => {
              if (normalizarUrl_(a.url) === refUrl) {
                a.descricao = val;
                a.desc = val;
              }
            });
          }
        });

        guardarDadosLocais();
        overlay.style.display = 'none';
        if (onDone) onDone();
      };

      overlay.style.display = 'flex';
    }

    /*************************************************
     *  PDF: GERAR (selecionados no separador QRCodes)
     *************************************************/
    async function gerarPDFQRCodes() {
      try {
        const ctx = getQrContext_();
        const formato = ctx.formato;
        const loja = ctx.loja;

        if (!formato || !loja) {
          alert('Seleciona Formato e Loja (Admin ou App) antes de gerar o PDF.');
          return;
        }

        const list = document.getElementById('admin-qrcodes-list');
        if (!list) {
          alert('Abre o separador QRCodes primeiro.');
          return;
        }

        const selectedIdxs = [...list.querySelectorAll('input.qr-ast-check:checked')]
          .map(cb => Number(cb.getAttribute('data-idx')))
          .filter(n => !Number.isNaN(n));

        if (selectedIdxs.length === 0) {
          alert('Seleciona pelo menos 1 assistente para imprimir.');
          return;
        }

        const setSel = new Set(selectedIdxs);

        const assistentes = (STATE.assistentes || [])
          .map((a, idx) => ({ ...a, __index: idx }))
          .filter(a => setSel.has(a.__index))
          .sort((a, b) => (a.label || '').localeCompare((b.label || '')));

        const semDescricao = assistentes.filter(a => !(a.descricao || a.desc || '').trim());
        if (semDescricao.length) {
          abrirModalDescricaoEmFalta(semDescricao, () => gerarPDFQRCodes());
          return;
        }

        const changesInfo = contarAlteracoesDescricaoNaoPublicadas_(assistentes);

        const jsPDF = await garantirPdfLib();
        const doc = new jsPDF({ format: 'a5', unit: 'mm' });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;

        const imageWidth = pageWidth - (margin * 2);
        const imageHeight = 108;

        const qrSize = 55;
        const qrX = (pageWidth - qrSize) / 2;
        const qrY = pageHeight - margin - qrSize;

        for (let idx = 0; idx < assistentes.length; idx++) {
          const a = assistentes[idx];
          if (idx > 0) doc.addPage('a5', 'p');

          const imgSrc = a.icone || 'AibyAuchan.png';
          let imgData = null;
          try { imgData = await carregarImagemComoDataURL(imgSrc); }
          catch { imgData = await carregarImagemComoDataURL('AibyAuchan.png'); }

          const qrUrl = criarUrlQRCode(a, formato, loja);
          const qrData = await gerarQRCodeDataURL(qrUrl);

          // IMAGEM
          doc.addImage(imgData, 'PNG', margin, margin, imageWidth, imageHeight);

          // T√çTULO
          const titleY = margin + imageHeight + 10;
          doc.setTextColor(0);
          doc.setFontSize(16);
          doc.text((a.label || a.nome || '').trim(), pageWidth / 2, titleY, { align: 'center' });

          // DESCRI√á√ÉO
          const descricao = (a.descricao || a.desc || '').trim();
          const descTop = titleY + 8;
          const textBottom = qrY - 6;
          const availableHeight = textBottom - descTop;

          let fontSize = 11;
          doc.setFontSize(fontSize);

          let lines = doc.splitTextToSize(descricao, imageWidth);
          let lineHeight = 5;
          let totalHeight = lines.length * lineHeight;

          if (totalHeight > availableHeight) {
            fontSize = 10;
            doc.setFontSize(fontSize);
            lines = doc.splitTextToSize(descricao, imageWidth);
            lineHeight = 4.6;
            totalHeight = lines.length * lineHeight;
          }

          while (totalHeight > availableHeight && lines.length > 2) {
            lines.pop();
            lines[lines.length - 1] = `${lines[lines.length - 1].replace(/\s*$/, '')}‚Ä¶`;
            totalHeight = lines.length * lineHeight;
          }

          doc.text(lines, pageWidth / 2, descTop, { align: 'center' });

          // QR
          doc.addImage(qrData, 'PNG', qrX, qrY, qrSize, qrSize);
        }

        if (changesInfo.count > 0) {
          alert(`‚ö†Ô∏è Tens ${changesInfo.count} descri√ß√µes novas/alteradas face ao publicado.\nVai √† aba Guardar e faz download do config.js para atualizar a app.`);
        }

        const fnameFmt = (formato === '*' ? 'QUALQUER_FORMATO' : formatarTextoBonito(formato));
        const fnameLoja = (loja === '*' ? 'QUALQUER_LOJA' : loja);
        doc.save(`qrcodes_${fnameFmt}_${fnameLoja}.pdf`);
      } catch (error) {
        console.error('PDF ERROR:', error);
        const detalhe = (error && (error.message || String(error))) || 'Erro desconhecido';
        alert('Falhou a gera√ß√£o do PDF. Detalhe: ' + detalhe);
      }
    }

  </script>
</body>
</html>
